<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <body>
    <div class="d-flex align-items-center mt-3">
  <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
    <i class="fas fa-tasks text-white"></i>
  </div>
  <div>
    <h5 class="mb-0 text-success">Reporte de Check List</h5>
    <small class="text-muted">Listas de verificaci√≥n</small>
  </div>
</div>


<div class="container-fluid my-1 px-0" id="page1">
<!-- ‚úÖ Botones superiores alineados: 2 a la izquierda, 1 a la derecha -->
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3" role="toolbar" aria-label="Botones principales del checklist">
  
  <!-- üîπ Grupo izquierdo: Reportar Checklist + Cumplimiento -->
  <div class="d-flex align-items-center gap-1">
    <!-- Bot√≥n Reportar Checklist -->
    <button type="button" class="btn btn-dark position-relative shadow-sm btn-sm rounded-pill"
            data-bs-toggle="modal" data-bs-target="#exampleModal2" onclick="clearForm()">
      <i class="fa-solid fa-user-shield"></i> Reportar CheckList
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
        <i class="fa fa-bell"></i> <span id="totalCheck2">0</span>/<span id="totalCheck1">0</span>
      </span>
    </button>

    <!-- Bot√≥n Cumplimiento -->
    <button type="button" class="btn btn-secondary shadow-sm btn-sm rounded-pill" id="btnActual">
      <i class="fa-solid fa-clock"></i> Cumplimiento
    </button>
  </div>

  <!-- üîπ Bot√≥n derecho: Filtros -->
  <button class="btn btn-outline-success btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosBusquedaCheck" aria-expanded="false" aria-controls="filtrosBusquedaCheck">
    <i class="fa fa-filter me-1"></i> Filtros
  </button>

</div>


<!-- Acorde√≥n/Filtros colapsables Check -->
<div class="collapse" id="filtrosBusquedaCheck">
  <div class="card shadow-sm border-0 mb-2 p-3">
    <div class="row row-cols-1 row-cols-md-2 g-2">
      <div class="col">
        <input type="text" class="form-control" id="busquedaCheck1" placeholder="Buscar 1...">
      </div>
      <div class="col">
        <select class="form-select" id="columnaFiltroCheck1">
          <option value="todos">Todas las columnas</option>
        </select>
      </div>
      <div class="col">
        <input type="text" class="form-control" id="busquedaCheck2" placeholder="Buscar 2...">
      </div>
      <div class="col">
        <select class="form-select" id="columnaFiltroCheck2">
          <option value="todos">Todas las columnas</option>
        </select>
      </div>
    </div>

    <div class="text-end mt-2">
      <button id="btnBuscarCheck" class="btn btn-info btn-sm px-3">
        <i class="fa fa-search me-1"></i>Buscar
      </button>
    </div>
  </div>
</div>


  <!-- Spinner -->
  <div id="spinnerCheck" class="text-center my-2" style="display: none;">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-1 small">Estamos organizando los datos para ti...</p>
  </div>

  <!-- Contenedor de tarjetas -->
  <div id="tabla-registro-checklist"></div>

  <!-- Bot√≥n Cargar m√°s -->
  <div class="text-center my-3">
    <button id="cargarMasCheck" class="btn btn-outline-secondary shadow-sm">
      <i class="fa-solid fa-arrow-down"></i> Ver m√°s
    </button>
  </div>
</div>

    <!-- ‚úÖ Skeleton loading -->
    <div id="skeleton-loading2" class="d-none">
      <div class="row g-3 py-2">
        <div class="col-sm-6 col-md-4 col-lg-3">
          <div class="skeleton-card"></div>
        </div>
        <div class="col-sm-6 col-md-4 col-lg-3">
          <div class="skeleton-card"></div>
        </div>
        <div class="col-sm-6 col-md-4 col-lg-3">
          <div class="skeleton-card"></div>
        </div>
        <div class="col-sm-6 col-md-4 col-lg-3">
          <div class="skeleton-card"></div>
        </div>
      </div>
    </div>
<script>
// ‚úÖ CACHE MANAGER
class CacheManagerCheck {
  static getWithExpiry(key, expiryHours = 12) {
    const item = localStorage.getItem(key);
    if (!item) return null;
    
    const data = JSON.parse(item);
    const now = new Date().getTime();
    
    if (now > data.timestamp + (expiryHours * 60 * 60 * 1000)) {
      localStorage.removeItem(key);
      return null;
    }
    
    return data.value;
  }
  
  static setWithExpiry(key, value, expiryHours = 12) {
    const data = {
      value: value,
      timestamp: new Date().getTime()
    };
    localStorage.setItem(key, JSON.stringify(data));
  }
  
  static getSessionWithExpiry(key, expiryMinutes = 30) {
    const item = sessionStorage.getItem(key);
    if (!item) return null;
    
    const data = JSON.parse(item);
    const now = new Date().getTime();
    
    if (now > data.timestamp + (expiryMinutes * 60 * 1000)) {
      sessionStorage.removeItem(key);
      return null;
    }
    
    return data.value;
  }
  
  static setSessionWithExpiry(key, value, expiryMinutes = 30) {
    const data = {
      value: value,
      timestamp: new Date().getTime()
    };
    sessionStorage.setItem(key, JSON.stringify(data));
  }
}

// ‚úÖ VARIABLES GLOBALES OPTIMIZADAS
let offsetCheck = 0;
const limitCheck = 20;
let searchCheck1 = "", searchCheck2 = "";
let columnaFiltroCheck1 = "todos", columnaFiltroCheck2 = "todos";
let headersCheckG = [];
let itemsDataCheck = [];
let itemsMap = new Map();
let totalCoincidenciasCheck = 0;

// ‚úÖ VARIABLES DE CONTROL - Agregadas las que faltaban
let searchTimeoutCheck;
let currentControllerCheck;
let isLoadingMoreCheck = false;
let currentSearchIdCheck = 0; // ‚úÖ NUEVO: ID √∫nico para cada b√∫squeda
let pendingReplacementCheck = false; // ‚úÖ NUEVO: Control de parpadeo

var cachedDataCheckList = []; 
let loginPasswords = [];
let deletePasswords = [];

// ‚úÖ DEBOUNCE MEJORADO
function debounceSearchCheck(func, delay = 300) {
  return function executedFunction(...args) {
    clearTimeout(searchTimeoutCheck);
    
    // ‚úÖ Cancelar petici√≥n anterior
    if (currentControllerCheck) {
      currentControllerCheck.abort();
    }
    
    searchTimeoutCheck = setTimeout(() => {
      func(...args);
    }, delay);
  };
}

// ‚úÖ CARGAR PASSWORDS CON CACHE (sin cambios)
async function cargarPasswordsCheck() {
  const cached = CacheManagerCheck.getSessionWithExpiry('passwordsCheck', 60);
  if (cached) {
    loginPasswords = cached.loginPasswords;
    deletePasswords = cached.deletePasswords;
    return Promise.resolve();
  }

  return new Promise((resolve) => {
    google.script.run.withSuccessHandler((passwords) => {
      loginPasswords = passwords.loginPasswords;
      deletePasswords = passwords.deletePasswords;
      CacheManagerCheck.setSessionWithExpiry('passwordsCheck', passwords, 60);
      resolve();
    }).getAccessPasswords();
  });
}

// ‚úÖ INICIALIZACI√ìN (sin cambios - est√° bien)
google.script.run.withSuccessHandler(data => {
  itemsDataCheck = data;

  itemsMap = data.reduce((map, row) => {
    const equipo = row[1];
    if (!map.has(equipo)) {
      map.set(equipo, []);
    }
    map.get(equipo).push(row);
    return map;
  }, new Map());

  google.script.run.withSuccessHandler(headersData => {
    headersCheckG = headersData;
    const sel1 = document.getElementById("columnaFiltroCheck1");
    const sel2 = document.getElementById("columnaFiltroCheck2");
    
    if (sel1 && sel2) {
      headersCheckG.forEach(col => {
        [sel1, sel2].forEach(sel => {
          const opt = document.createElement("option");
          opt.value = col;
          opt.textContent = col;
          sel.appendChild(opt);
        });
      });
    }

    cargarDatosCheckG();
    actualizarLabelsYPlaceholdersChecklist();
  }).getHeadersCheck();

}).getItemsData();

const camposChecklist = {
  ad9: 5,
  ad6: 6,
  ad5: 7,
  numid: 0,
  empresacheck: 1,     // Nuevo campo
  name: 2,
  codigo: 3,
  inps: 4,
  procesoCheck: 5,
  no: 6,
  lugarCheck: 7,
  idline: 9,
  accion: 8,
  imagen: 10,
  estadoCheck2: 12,
  plazoCheck: 13
};

function actualizarLabelsYPlaceholdersChecklist() {
  Object.entries(camposChecklist).forEach(([id, index]) => {
    const label = document.querySelector(`label[for="${id}"]`) ||
                  document.querySelector(`#${id}`)?.closest(".col-md-6, .col-12")?.querySelector("label");

    const input = document.getElementById(id);

    if (label && headersCheckG[index]) {
      label.textContent = headersCheckG[index];
    }

    if (input && headersCheckG[index] && input.tagName === "INPUT" && input.type !== "file") {
      input.placeholder = headersCheckG[index];
    }
  });
}

// ‚úÖ EVENT LISTENERS MEJORADOS
document.addEventListener('DOMContentLoaded', function() {
  const btnBuscarCheck = document.getElementById("btnBuscarCheck");
  const btncargarMasCheck = document.getElementById("cargarMasCheck");
  const busquedaCheck1 = document.getElementById("busquedaCheck1");
  const busquedaCheck2 = document.getElementById("busquedaCheck2");
  
  if (btnBuscarCheck) {
    btnBuscarCheck.addEventListener("click", (e) => {
      e.preventDefault();
      debounceSearchCheck(reiniciarTablaCheck)();
    });
  }
  
  if (btncargarMasCheck) {
    btncargarMasCheck.addEventListener("click", (e) => {
      e.preventDefault();
      if (!isLoadingMoreCheck) {
        cargarDatosCheckG();
      }
    });
  }

  if (busquedaCheck1) {
    busquedaCheck1.addEventListener("input", debounceSearchCheck(reiniciarTablaCheck));
  }
  if (busquedaCheck2) {
    busquedaCheck2.addEventListener("input", debounceSearchCheck(reiniciarTablaCheck));
  }

  // Cargar totales
  let totalCheck1 = document.getElementById('totalCheck1');
  let totalCheck2 = document.getElementById('totalCheck2');
  
  if (totalCheck1 && totalCheck2) {
    google.script.run.withSuccessHandler(data => {
      totalCheck1.innerHTML = data[0];
      totalCheck2.innerHTML = data[1];
    }).setStatusCheck();
  }

  cargarPasswordsCheck();
  // ‚úÖ CAMBIO: Usar skeleton en lugar de spinner para carga inicial
  mostrarEstadoCargaCheck('skeleton', true);
});

function checkPasswordLocal(password) {
  return loginPasswords.includes(password);
}

function checkDeletePasswordLocal(password) {
  return deletePasswords.includes(password);
}

// ‚úÖ CORREGIR: Reiniciar tabla sin parpadeo
function reiniciarTablaCheck() {
  currentSearchIdCheck++;
  const searchId = currentSearchIdCheck;
  
  if (currentControllerCheck) {
    currentControllerCheck.abort();
  }
  currentControllerCheck = new AbortController();

  offsetCheck = 0;
  cachedDataCheckList = [];
  isLoadingMoreCheck = false;
  pendingReplacementCheck = true;
  
  searchCheck1 = document.getElementById("busquedaCheck1")?.value.trim() || "";
  searchCheck2 = document.getElementById("busquedaCheck2")?.value.trim() || "";
  columnaFiltroCheck1 = document.getElementById("columnaFiltroCheck1")?.value || "todos";
  columnaFiltroCheck2 = document.getElementById("columnaFiltroCheck2")?.value || "todos";
  
  // ‚úÖ MOSTRAR SKELETON para nueva b√∫squeda
  mostrarEstadoCargaCheck('skeleton', true);
  
  cargarDatosCheckG(searchId);
}

// ‚úÖ CORREGIR: Cargar datos con validaci√≥n de b√∫squeda
function cargarDatosCheckG(searchId = currentSearchIdCheck) {
  if (isLoadingMoreCheck) return;
  isLoadingMoreCheck = true;
  
  // ‚úÖ Usar skeleton solo para b√∫squeda nueva (offset 0)
  // Usar spinner para scroll infinito (offset > 0)
  if (offsetCheck === 0) {
    mostrarEstadoCargaCheck('skeleton', true);
  } else {
    mostrarEstadoCargaCheck('spinner', true);
  }
  
  const btnBuscarCheck = document.getElementById("btnBuscarCheck");
  const btncargarMasCheck = document.getElementById("cargarMasCheck");
  
  if (btnBuscarCheck) btnBuscarCheck.disabled = true;
  if (btncargarMasCheck) btncargarMasCheck.disabled = true;

  google.script.run
    .withSuccessHandler((data) => {
      if (searchId !== currentSearchIdCheck) {
        console.log("Respuesta checklist obsoleta ignorada");
        isLoadingMoreCheck = false;
        return;
      }
      renderizarTablaCheck(data, searchId);
    })
    .withFailureHandler(err => {
      console.error("Error cargando datos checklist:", err);
      mostrarEstadoCargaCheck('', false); // ‚úÖ Ocultar todo
      isLoadingMoreCheck = false;
      if (btnBuscarCheck) btnBuscarCheck.disabled = false;
      if (btncargarMasCheck) btncargarMasCheck.disabled = false;
    })
    .getDatosRegistroCheck(offsetCheck, limitCheck, searchCheck1, searchCheck2, columnaFiltroCheck1, columnaFiltroCheck2);
}

// ‚úÖ CORREGIR: Renderizar tabla con validaci√≥n y sin parpadeo
function renderizarTablaCheck(respuesta, searchId = currentSearchIdCheck) {
  if (searchId !== currentSearchIdCheck) {
    console.log("Renderizado checklist obsoleto cancelado");
    isLoadingMoreCheck = false;
    return;
  }

  const contenedorCheck = document.getElementById("tabla-registro-checklist");
  const btnBuscarCheck = document.getElementById("btnBuscarCheck");
  const btncargarMasCheck = document.getElementById("cargarMasCheck");

  if (!respuesta || !respuesta.data || respuesta.data.length === 0) {
    if (offsetCheck === 0) {
      contenedorCheck.innerHTML = "<p>No se encontraron resultados.</p>";
      pendingReplacementCheck = false;
    }
    mostrarEstadoCargaCheck('', false); // ‚úÖ Ocultar todo
    isLoadingMoreCheck = false;
    if (btnBuscarCheck) btnBuscarCheck.disabled = false;
    if (btncargarMasCheck) btncargarMasCheck.disabled = false;
    return;
  }

  // ‚úÖ Si es nueva b√∫squeda (offset 0), REEMPLAZAR todo
  if (offsetCheck === 0 && pendingReplacementCheck) {
    contenedorCheck.innerHTML = "";
    cachedDataCheckList = respuesta;
    pendingReplacementCheck = false;
  }

  // ‚úÖ OCULTAR loading despu√©s de procesar datos
  mostrarEstadoCargaCheck('', false);
  isLoadingMoreCheck = false;
  if (btnBuscarCheck) btnBuscarCheck.disabled = false;
  if (btncargarMasCheck) btncargarMasCheck.disabled = false;

  totalCoincidenciasCheck = respuesta.total;

  const fragment = document.createDocumentFragment();
  const cardsRow = document.createElement("div");
  cardsRow.className = "row g-3 py-2";

  // ‚úÖ RENDERIZAR DATOS NORMALMENTE
  respuesta.data.forEach(fila => {
    const complianceList = fila[14].split(',').map(c => c.trim());
    const items = itemsMap.get(fila[2]) || [];

    // ‚úÖ CONTADOR MODIFICADO: Excluir t√≠tulos (NA de √≠tems que empiezan con n√∫mero+punto)
    const { siCount, noCount, otrosCount } = complianceList.reduce((acc, v, i) => {
      const itemText = items[i] && items[i][2] ? items[i][2] : '';
      const esTitulo = /^\d+\./.test(itemText.trim()) && v === 'NA';
      if (esTitulo) return acc; // No contar t√≠tulos
      if (v === 'Si') acc.siCount++;
      else if (v === 'No') acc.noCount++;
      else acc.otrosCount++;
      return acc;
    }, { siCount: 0, noCount: 0, otrosCount: 0 });

    // ‚úÖ GENERAR DETALLES CON T√çTULOS VISUALES + OBSERVACIONES
    const { texto: detallesTexto, html: detallesHTML, sectionTitles } = generarDetallesItems(complianceList, items);
    const observacionesHTML = generarObservacionesHTML(fila, sectionTitles);

    const mensajeWhatsApp = generarMensajeWhatsApp(fila, siCount, noCount, detallesTexto);
    const imagenPrincipal = (!fila[10] || fila[10].trim() === "" || fila[10] === "NA") ? "https://lh5.googleusercontent.com/d/1uU0A4gwDjF2X35ussSiTnuXbibK6lnGN" : fila[10];

    const cardHTML = `
  <div class='col-sm-6 col-md-4 col-lg-3'>
    <div class='tiktok-card' style='overflow: hidden; position: relative;'>
      
           ${(() => {
        const totalRespuestas = siCount + noCount;
        const cumplimiento = totalRespuestas > 0 ? Math.round((siCount / totalRespuestas) * 100) : 0;
        const estado = fila[12] || 'Sin estado';

        // Color del estado
        let colorEstado = '#6c757d'; // gris por defecto
        if (estado === 'Abierto') colorEstado = '#dc3545'; // rojo
        else if (estado === 'Cerrado') colorEstado = '#28a745'; // verde
        else if (estado === 'Conforme') colorEstado = '#ffc107'; // amarillo

        // Color din√°mico seg√∫n porcentaje
        let colorCumplimiento = '#dc3545'; // rojo por defecto
        if (cumplimiento >= 95) colorCumplimiento = '#28a745'; // verde
        else if (cumplimiento >= 80) colorCumplimiento = '#ffc107'; // amarillo

        return `
          <div style="position: absolute; top: 10px; left: 5px; z-index: 5; display: flex; gap: 6px; flex-wrap: wrap;">
            <div class="estado-badge" style="background-color:${colorEstado}; left: 55px;">${estado}</div>
            <div class="estado-badge" style="background-color:${colorCumplimiento}; color:#000;">
              ${cumplimiento}%
            </div>
          </div>`;
      })()}

      <img src='${imagenPrincipal}' loading="lazy" onclick='showImageCheckList("${imagenPrincipal}")'>
      ${fila[11] && fila[11].trim() !== "" && fila[11] !== "NA" ? `
        <div style='position: absolute; top: 12px; right: 60px; z-index: 3;'>
          <button onclick='showImageCheckList("${fila[11]}")' style='border: none; background: transparent; padding: 0;'>
            <img src='${fila[11]}' loading="lazy" style='width: 44px; height: 44px; object-fit: cover; border-radius: 8px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.5);'>
          </button>
        </div>` : ""}
      <div class='overlay-buttons'>
        <div class="avatar-wrapper" onclick="toggleNombreUsuario(this)">
          <div class="avatar-circle-only">${fila[6].split(' ').map(p => p[0]).join('').substring(0, 3).toUpperCase()}</div>
          <div class="nombre-completo hidden-nombre">${fila[6]}</div>
        </div>
        <button onclick='checkPasswordAndEdit(${JSON.stringify(fila)})'><i class='fa-solid fa-screwdriver-wrench'></i></button>
        <button onclick='deleteData(${fila[0]}, this)'><i class='fa fa-trash'></i></button>
        <button onclick="sendWhatsApp('${mensajeWhatsApp}')"><i class="fa-brands fa-whatsapp"></i></button>
        <button id='exportPdfBtn' data-column-a='${fila[0]}'><i class="fa-solid fa-file-pdf"></i></button>
      </div>
      <div class='tiktok-text' style='max-height: 80%; overflow-y: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none;'>
        <div style="font-size: 16px; font-weight: bold; color: white;">ID: ${fila[0]} ‚Äì ${fila[2]}</div>
        <div><strong>${headersCheckG[7] || "Lugar"}:</strong> ${fila[7]}</div>
        <div>
          <b>Cumplimiento:</b>
          <i class="fa-solid fa-check" style="color:green;"></i> ${siCount} &nbsp;
          <i class="fa-solid fa-xmark" style="color:red;"></i> ${noCount} &nbsp;
          <i class="fa-solid fa-circle" style="color:blue;"></i> ${otrosCount}
        </div>
        <div id='extra-content-check-${fila[0]}' style='display: none; margin-top: 6px; font-size: 13px;'>
        <ul style="padding: 0; margin: 0;">
          <li><b>${headersCheckG[9] || "Fecha"}:</b> ${fila[9]}</li>
          <li><b>${headersCheckG[1] || "Empresa"}:</b> ${fila[1]}</li>
          <li><b>${headersCheckG[5] || "Proceso"}:</b> ${fila[5]}</li>
          <li><b>${headersCheckG[13] || "Frecuencia"}:</b> ${fila[13]}</li>
          <li><b>${headersCheckG[8] || "Plan"}:</b> ${fila[8]}</li>
          <li><b>${headersCheckG[4] || "√Årea"}:</b> ${fila[4]}</li>
        </ul>
          <hr class="my-1">
          <div class="mt-2">${detallesHTML}</div>
          ${observacionesHTML}
        </div>
        <div class='text-end mb-0'>
          <a href='#' class='text-info fw-bold' onclick='toggleExtraContentCheck("${fila[0]}", this); return false;'>Ver m√°s</a>
        </div>
      </div>
    </div>
  </div>
`;

    const div = document.createElement("div");
    div.innerHTML = cardHTML;
    cardsRow.appendChild(div.firstElementChild);
  });

  // ‚úÖ COMPLETAR FILA INCOMPLETA SI ES LA √öLTIMA CARGA
  const esUltimaCarga = (offsetCheck + respuesta.data.length) >= totalCoincidenciasCheck;
  if (esUltimaCarga) {
    const totalElementosEnPantalla = respuesta.data.length;
    const elementosEnUltimaFila = totalElementosEnPantalla % 4;
    
    if (elementosEnUltimaFila > 0) {
      const placeholdersNecesarios = 4 - elementosEnUltimaFila;
      
      for (let i = 0; i < placeholdersNecesarios; i++) {
        const placeholder = document.createElement('div');
        placeholder.className = 'col-sm-6 col-md-4 col-lg-3';
        placeholder.innerHTML = '<div style="height: 1px; visibility: hidden;"></div>';
        cardsRow.appendChild(placeholder);
      }
    }
  }

  fragment.appendChild(cardsRow);
  contenedorCheck.appendChild(fragment);
  
  offsetCheck += limitCheck;
  
  // ‚úÖ Actualizar bot√≥n cargar m√°s
  if (btncargarMasCheck) {
    const hayMasDatos = offsetCheck < totalCoincidenciasCheck;
    
    if (hayMasDatos) {
      btncargarMasCheck.style.display = "block";
      btncargarMasCheck.disabled = false;
      btncargarMasCheck.innerHTML = `Cargar m√°s (${offsetCheck}/${totalCoincidenciasCheck})`;
    } else {
      btncargarMasCheck.style.display = "none";
    }
  }
}

// ‚úÖ MOSTRAR CARGA MEJORADA (sin modificar DOM hasta tener datos)
function mostrarEstadoCargaCheck(tipo, mostrar = true) {
  const skeleton = document.getElementById('skeleton-loading2');
  const spinner = document.getElementById('spinnerCheck');
  const container = document.getElementById("tabla-registro-checklist");
  
  if (tipo === 'skeleton' && mostrar) {
    // Mostrar skeleton al inicio de b√∫squeda
    skeleton?.classList.remove('d-none');
    spinner?.style.setProperty('display', 'none');
    if (container) {
      container.style.opacity = "0.6";
      container.style.pointerEvents = "none";
    }
  } else if (tipo === 'spinner' && mostrar) {
    // Mostrar spinner para carga adicional (scroll infinito)
    skeleton?.classList.add('d-none');
    spinner?.style.setProperty('display', 'block');
    if (container) {
      container.style.opacity = "0.6";
      container.style.pointerEvents = "none";
    }
  } else {
    // Ocultar todo
    skeleton?.classList.add('d-none');
    spinner?.style.setProperty('display', 'none');
    if (container) {
      container.style.opacity = "1";
      container.style.pointerEvents = "auto";
    }
  }
}

// ‚úÖ SCROLL MEJORADO
document.addEventListener('scroll', function() {
  const btncargarMasCheck = document.getElementById("cargarMasCheck");
  if (!btncargarMasCheck || isLoadingMoreCheck) return;
  
  const scrollPosition = window.innerHeight + window.scrollY;
  const documentHeight = document.documentElement.scrollHeight;
  const threshold = documentHeight - 800;
  
  if (scrollPosition >= threshold && offsetCheck < totalCoincidenciasCheck) {
    cargarDatosCheckG(); // ‚úÖ Usar funci√≥n principal
  }
}, { passive: true });

// ‚úÖ LIMPIEZA DE MEMORIA AL CERRAR
window.addEventListener('beforeunload', function() {
  if (currentControllerCheck) {
    currentControllerCheck.abort();
  }
  clearTimeout(searchTimeoutCheck);
});


function toggleExtraContentCheck(id, el) {
  const content = document.getElementById(`extra-content-check-${id}`);
  const visible = content.style.display === "block";
  content.style.display = visible ? "none" : "block";
  el.textContent = visible ? "Ver m√°s" : "Ver menos";
}


//Funci√≥n password
async function checkPasswordAndEdit(rowData) {
  const { value: password, isConfirmed, isDismissed } = await Swal.fire({
    title: 'Ingrese su password',
    input: 'password',
    inputLabel: 'Se requiere password para la edici√≥n',
    inputPlaceholder: 'Password aqu√≠',
    inputAttributes: {
      maxlength: 10,
      autocapitalize: 'off',
      autocorrect: 'off'
    },
    showCancelButton: true,
    confirmButtonText: 'Aceptar',
    cancelButtonText: 'Cancelar'
  });

  if (isDismissed) {
    console.log('El usuario cancel√≥ la edici√≥n.');
    return; // No hacer nada si cancel√≥
  }

  if (isConfirmed && password) {
    // Mostrar mensaje de carga
    Swal.fire({
      title: 'Verificando...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading(),
    });

    // Simular verificaci√≥n local
    setTimeout(() => {
      Swal.close(); // Cerrar mensaje de carga

      if (checkPasswordLocal(password)) {
        fillModalWithData(rowData); // Llenar modal con los datos
        $('#staticBackdrop').modal('show');
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Password incorrecto',
          timer: 1500,
          showConfirmButton: false
        });
      }
    }, 300);
  }
}


function fillModalWithData(data) {
  // ‚úÖ Guardar data completa para subsanaci√≥n
  window.currentCheckData = data;

  document.getElementById('numid').value = data[0];
  document.getElementById('empresacheck').value = data[1];
  document.getElementById('name').value = data[2];
  document.getElementById('codigo').value = data[3];
  document.getElementById('inps').value = data[4];
  document.getElementById('procesoCheck').value = data[5];
  document.getElementById('no').value = data[6];
  document.getElementById('lugarCheck').value = data[7];
  document.getElementById('accion').value = data[8];
  document.getElementById('idline').value = data[9];
  document.getElementById('imagen').value = data[10];
  document.getElementById('plazoCheck').value = data[13];

  // Mostrar imagen original si hay URL
  const imagenPreview = document.getElementById('imagen-preview');
  if (data[10]) {
    imagenPreview.src = data[10];
    imagenPreview.style.display = 'block';
  } else {
    imagenPreview.src = '';
    imagenPreview.style.display = 'none';
  }

  // ‚úÖ Actualizar contadores de cumplimiento
  if (typeof updateComplianceCounts === 'function') {
    updateComplianceCounts(data[2], data[14]);
  } else if (typeof updateComplianceCountsAndShowItems === 'function') {
    updateComplianceCountsAndShowItems(data[2], data[14]);
  }

  // ‚úÖ Poblar secci√≥n de observaciones para subsanaci√≥n
  if (typeof populateSubsanacion === 'function') {
    populateSubsanacion(data, data[2]);
  }
}


//DELETE DATA
async function deleteData(id, el) {
  const { value: password } = await Swal.fire({
    title: 'Ingrese su password',
    input: 'password',
    inputLabel: 'Se requiere password para eliminar',
    inputPlaceholder: 'Password aqu√≠',
    inputAttributes: {
      maxlength: 10,
      autocapitalize: 'off',
      autocorrect: 'off'
    },
    showCancelButton: true
  });

  if (password) {
    if (checkDeletePasswordLocal(password)) {
      // Mostrar mensaje de validaci√≥n
      Swal.fire({
        title: 'Password correcto',
        text: 'Eliminando...',
        icon: 'success',
        timer: 2500,
        showConfirmButton: false,
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Ejecutar eliminaci√≥n
      google.script.run.withSuccessHandler(() => {
        reiniciarTablaCheck();
        Swal.close(); // Opcional si quieres cerrar antes de tiempo
      }).deleteData(id);

    } else {
      Swal.fire('Password incorrecto', '', 'error');
    }
  }
}

//ampliar imagen
function showImageCheckList(imgUrl) {
  var modal = document.createElement('div');
  modal.style.position = 'fixed';
  modal.style.top = 0;
  modal.style.bottom = 0;
  modal.style.left = 0;
  modal.style.right = 0;
  modal.style.zIndex = 9999;
  modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';

  var img = document.createElement('img');
  img.src = imgUrl;
  img.style.maxWidth = '90%';
  img.style.maxHeight = '90%';
  img.style.border = '1px solid white';
  img.style.borderRadius = '15px';
  img.style.boxShadow = '0 0 20px rgba(255,255,255,0.5)';

  modal.appendChild(img);

  modal.onclick = function () {
    modal.remove();
  };

  document.body.appendChild(modal);
}

</script>
<script>

// ‚úÖ MODIFICADO: T√≠tulos con fondo azul, sin numeraci√≥n, sin contar
function generarDetallesItems(complianceList, items) {
  let texto = '', html = '';
  let itemCounter = 0;
  let sectionTitles = [];

  complianceList.forEach((valor, i) => {
    const itemText = items[i] && items[i][2] ? items[i][2] : '';
    const esTitulo = /^\d+\./.test(itemText.trim()) && valor === 'NA';

    if (esTitulo) {
      // ‚úÖ T√çTULO: fondo azul, letra blanca, sin n√∫mero, no se cuenta
      sectionTitles.push(itemText.replace(/^\d+\.\s*/, '').trim());
      html += `<div style="background-color:#2c5aa0; color:#fff; font-weight:bold; padding:3px 8px; border-radius:3px; margin:5px 0 2px 0; text-align:center; font-size:0.82em;">
        <i class="fa-solid fa-list-check me-1"></i>${itemText}
      </div>`;
      texto += `‚îÄ‚îÄ ${itemText} ‚îÄ‚îÄ\n`;
    } else {
      // ‚úÖ √çTEM NORMAL: se cuenta secuencialmente
      itemCounter++;
      if (valor === 'No') {
        texto += `X ${itemCounter}. ${itemText}\n`;
        html += `<div class="small" style="color:#ff81b4;"><b><i class="fa-solid fa-square-xmark"></i></b> ${itemCounter}. ${itemText}</div>`;
      } else if (valor === 'Si') {
        texto += `‚úì ${itemCounter}. ${itemText}\n`;
        html += `<div class="small" style="color:#81ff8a;"><b><i class="fa-solid fa-square-check"></i></b> ${itemCounter}. ${itemText}</div>`;
      } else {
        texto += `O ${itemCounter}. ${itemText}\n`;
        html += `<div class="small" style="color:#83c1ff;"><i class="fa-regular fa-square-full"></i> ${itemCounter}. ${itemText}</div>`;
      }
    }
  });

  return { texto, html, sectionTitles };
}

// ‚úÖ NUEVA FUNCI√ìN: Generar HTML de observaciones por secci√≥n
function generarObservacionesHTML(fila, sectionTitles) {
  let html = '';
  let hasObs = false;

  for (let s = 0; s < 10; s++) {
    // Columnas en fila (0-indexed): foto=68+s*3, subsanaci√≥n=69+s*3, comentario=70+s*3
    var fotoIdx = 68 + s * 3;
    var subIdx = 69 + s * 3;
    var comentarioIdx = 70 + s * 3;

    var foto = (fila[fotoIdx] || '').trim();
    var subsanacion = (fila[subIdx] || '').trim();
    var comentario = (fila[comentarioIdx] || '').trim();

    if (foto || comentario) {
      if (!hasObs) {
        html += `<hr class="my-2" style="border-color:rgba(255,255,255,0.15);">
          <div style="font-weight:bold; color:#ff9800; margin:4px 0; font-size:0.9em;">
            <i class="fa-solid fa-clipboard-list me-1"></i>OBSERVACIONES
          </div>`;
        hasObs = true;
      }

      var titulo = sectionTitles[s] || ('Secci√≥n ' + (s + 1));

      html += `<div style="margin:4px 0; padding:5px 8px; background:rgba(255,255,255,0.06); border-radius:4px; border-left:3px solid ${subsanacion ? '#28a745' : '#ff9800'};">`;
      html += `<div style="font-weight:bold; font-size:0.82em; color:#ffcc80;">‚ñ∏ ${titulo}`;
      if (subsanacion) {
        html += ` <span style="font-size:0.7em; background:#28a745; color:#fff; padding:1px 5px; border-radius:3px; margin-left:4px;">‚úì Subsanada</span>`;
      } else {
        html += ` <span style="font-size:0.7em; background:#ff9800; color:#fff; padding:1px 5px; border-radius:3px; margin-left:4px;">Pendiente</span>`;
      }
      html += `</div>`;

      if (comentario) {
        html += `<div style="font-size:0.78em; color:#ddd; margin:2px 0;"><i class="fa-regular fa-comment me-1"></i>${comentario}</div>`;
      }

      // Fotos: original + subsanaci√≥n
      html += `<div style="display:flex; gap:8px; flex-wrap:wrap; margin:3px 0;">`;
      if (foto) {
        html += `<div>
          <div style="font-size:0.65em; color:#aaa;">Original:</div>
          <div onclick='showImageCheckList("${foto}")' 
            style="width:56px; height:56px; background-image:url(${foto}); background-size:cover; background-position:center; 
            border-radius:4px; border:1px solid rgba(255,255,255,0.3); cursor:pointer; display:inline-block; position:relative;" 
            title="Tap para ampliar"><i class="fa-solid fa-expand" style="position:absolute; bottom:2px; right:2px; font-size:8px; color:rgba(255,255,255,0.7);"></i></div>
        </div>`;
      }
      if (subsanacion) {
        html += `<div>
          <div style="font-size:0.65em; color:#8f8;">Subsanaci√≥n:</div>
          <div onclick='showImageCheckList("${subsanacion}")' 
            style="width:56px; height:56px; background-image:url(${subsanacion}); background-size:cover; background-position:center; 
            border-radius:4px; border:2px solid #28a745; cursor:pointer; display:inline-block; position:relative;" 
            title="Tap para ampliar"><i class="fa-solid fa-expand" style="position:absolute; bottom:2px; right:2px; font-size:8px; color:rgba(255,255,255,0.7);"></i></div>
        </div>`;
      }
      html += `</div>`;

      html += `</div>`;
    }
  }

  return html;
}

function generarMensajeWhatsApp(fila, siCount, noCount, detallesTexto) {
  return `*---REPORTE DE CHECKLIST---*
*ID:* ${fila[0]}
*Empresa:* ${fila[1]}
*Equipo:* ${fila[2]}
*C√≥digo:* ${fila[3]}
*√Årea:* ${fila[4]}
*Inspector:* ${fila[6]}
*Proceso:* ${fila[5]}
*Lugar:* ${fila[7]}
*Fecha:* ${fila[9]}
*Cumplimiento - S√≠:* ${siCount}
*Cumplimiento - No:* ${noCount}
*Plan:* ${fila[8]}
*Imagen:* ${fila[10]}
*Correcci√≥n:* ${fila[11]}
*Estado:* ${fila[12]}
*Plazo:* ${fila[13]}

*√çtems evaluados:*
${detallesTexto}`.replace(/\n/g, "\\n").replace(/"/g, '&quot;');
}

</script>
</body>
</html>