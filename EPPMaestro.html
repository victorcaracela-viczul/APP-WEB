<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>

      /* ANIMACI√ìN DE CARGA DE IM√ÅGENES */
.header-epp-img {
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.header-epp-img[src*="placeholder"] {
  opacity: 0.5;
  filter: grayscale(100%);
}

/* ASEGURAR VISIBILIDAD INMEDIATA */
.tab-pane {
  min-height: 400px;
}

.tab-pane.active {
  display: block !important;
  opacity: 1 !important;
}

.tabla-horizontal {
  opacity: 1 !important;
  visibility: visible !important;
}



      /* ESTILOS ESPEC√çFICOS DEL MAESTRO EPP */
      .email-cell {
        max-width: 110px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* TABLA HORIZONTAL EPP */
      .scroll-horizontal {
        overflow-x: auto;
        overflow-y: hidden;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        background: var(--white);
        border: 1px solid var(--gray-border);
      }

      .tabla-horizontal {
        display: inline-flex;
        font-size: 11px;
        min-width: 100%;
      }

      .columna-trabajador {
        display: flex;
        flex-direction: column;
        background: var(--white);
        border-right: 2px solid var(--gray-border);
        position: sticky;
        left: 0;
        z-index: 10;
      }

      .header-trabajador {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        color: #111827;
        padding: 12px;
        text-align: center;
        font-weight: 600;
        border-bottom: 2px solid var(--gray-border);
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .celda-trabajador {
        padding: 10px 15px;
        border-bottom: 1px solid var(--gray-border);
        text-align: left;
        height: 45px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-width: 200px;
        transition: background 0.2s;
        cursor: pointer;
      }
      
      .celda-trabajador:hover {
        background: var(--hover-bg);
      }
      
      .fila-oculta {
        display: none !important;
      }

      .nombre-trabajador {
        font-weight: 600;
        color: #111827;
      }

      .cargo-trabajador {
        font-size: 10px;
        color: #6c757d;
      }

      .columna-epp {
        display: flex;
        flex-direction: column;
        background: var(--white);
        border-right: 1px solid var(--gray-border);
        min-width: 80px;
      }

      .header-epp {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        color: #111827;
        padding: 8px;
        text-align: center;
        font-weight: 600;
        border-bottom: 2px solid var(--gray-border);
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .header-epp:hover {
        background: var(--hover-bg);
        transform: scale(1.05);
      }

      .header-epp-img {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        object-fit: cover;
        border: 2px solid var(--gray-border);
        background: var(--white);
        transition: all 0.3s;
      }
      
      .header-epp:hover .header-epp-img {
        border-color: var(--main-text-color);
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
      }

      .celda-epp {
        padding: 10px;
        border-bottom: 1px solid var(--gray-border);
        text-align: center;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }
      
      .celda-epp:hover {
        background: var(--hover-bg);
      }

      .semaforo {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: inline-block;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        transition: all 0.3s;
      }
      
      .semaforo:hover {
        transform: scale(1.2);
      }

      .st-OK { 
        background: #198754;
        border: 2px solid #146c43;
      }

      .st-NOTIF { 
        background: #ffc107;
        border: 2px solid #e0a800;
      }

      .st-ENTR { 
        background: #dc3545;
        border: 2px solid #b02a37;
      }

      .sin-asignar {
        background: #e9ecef;
        border: 2px solid #ced4da;
      }

      /* TOOLTIP */
      .tooltip-epp {
        position: fixed;
        background: var(--white);
        color: #111827;
        padding: 16px;
        border-radius: 12px;
        font-size: 12px;
        z-index: 10000;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        max-width: 300px;
        border: 1px solid var(--gray-border);
      }

      .tooltip-epp.show {
        opacity: 1;
      }

      .tooltip-header {
        font-weight: 600;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--gray-border);
        color: #111827;
      }

      .tooltip-row {
        margin: 6px 0;
        display: flex;
        justify-content: space-between;
      }

      .tooltip-label {
        color: #6c757d;
        font-size: 11px;
      }

      .tooltip-value {
        font-weight: 600;
        color: #111827;
      }

      .badge-retraso {
        background: #dc3545;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        margin-top: 8px;
        display: inline-block;
      }

      .badge-dias {
        background: #198754;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        margin-top: 8px;
        display: inline-block;
      }

      /* KPIs */
      .kpi-card {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        border-radius: 10px;
        background: var(--white);
        border: 1px solid var(--gray-border);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
      }
      
      .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      
      .kpi-card.verde { border-left: 4px solid #198754; }
      .kpi-card.naranja { border-left: 4px solid #ffc107; }
      .kpi-card.rojo { border-left: 4px solid #dc3545; }
      
      .kpi-value {
        font-size: 24px;
        font-weight: 700;
        line-height: 1;
      }
      
      .kpi-label {
        font-size: 11px;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
      }

      /* LEYENDA */
      .leyenda-item {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #374151;
        margin-right: 20px;
      }
      
      .leyenda-circulo {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      }

      /* MODAL */
      .modal-imagen {
        display: none;
        position: fixed;
        z-index: 10001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
      }
      
      .modal-imagen-content {
        position: relative;
        margin: 5% auto;
        width: 90%;
        max-width: 600px;
        background: var(--white);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 12px 40px rgba(0,0,0,0.3);
      }
      
      .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 28px;
        font-weight: bold;
        color: #6c757d;
        cursor: pointer;
      }
      
      .modal-close:hover {
        color: #dc3545;
      }
      
      .modal-imagen-img {
        width: 100%;
        border-radius: 10px;
        margin-bottom: 15px;
      }
      
      .modal-imagen-title {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 10px;
      }
      
      .modal-imagen-desc {
        color: #6c757d;
        font-size: 14px;
      }

      /* ALERTAS */
      .alert-card {
        background: var(--white);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 4px solid #dc3545;
        border: 1px solid var(--gray-border);
        transition: all 0.3s;
      }
      
      .alert-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        transform: translateX(5px);
      }
      
      .alert-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      
      .alert-title {
        font-weight: 600;
        color: #111827;
        font-size: 15px;
      }
      
      .alert-badge {
        background: #dc3545;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }
      
      .alert-body {
        color: #6c757d;
        font-size: 13px;
        line-height: 1.6;
      }
      
      .alert-meta {
        display: flex;
        gap: 15px;
        margin-top: 10px;
        font-size: 12px;
        flex-wrap: wrap;
      }
      
      .alert-meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
        color: #6c757d;
      }
    </style>
  </head>
  <body>

<!-- ENCABEZADO -->
<div class="d-flex align-items-center mt-3">
  <div class="bg-purple rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; background-color: #6f42c1;">
    <i class="fas fa-hard-hat text-white"></i>
  </div>
  <div>
    <h5 class="mb-0" style="color: #6f42c1;">Maestro EPP</h5>
    <small class="text-muted">Control de equipos de protecci√≥n personal</small>
  </div>
</div>

<div class="container-fluid my-1 px-0">

  <!-- TABS -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#vistaGeneral" onclick="mostrarVista('general')">
        <i class="fas fa-th"></i> Vista General
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#vistaAlertas" onclick="mostrarVista('alertas')">
        <i class="fas fa-exclamation-triangle"></i> Alertas y Pendientes
        <span id="badgeAlertas" class="badge bg-danger ms-1">0</span>
      </a>
    </li>
  </ul>

  <!-- CONTENIDO DE TABS -->
  <div class="tab-content">
    
    <!-- TAB: VISTA GENERAL -->
    <div id="vistaGeneral" class="tab-pane fade show active">

      <!-- LEYENDA -->
      <div class="mb-2">
        <strong>Leyenda:</strong>
        <div class="leyenda-item">
          <span class="leyenda-circulo" style="background: #198754; border: 2px solid #146c43;"></span>
          <span>Vigente</span>
        </div>
        <div class="leyenda-item">
          <span class="leyenda-circulo" style="background: #ffc107; border: 2px solid #e0a800;"></span>
          <span>Por vencer (‚â§15 d√≠as)</span>
        </div>
        <div class="leyenda-item">
          <span class="leyenda-circulo" style="background: #dc3545; border: 2px solid #b02a37;"></span>
          <span>Vencido</span>
        </div>
        <div class="leyenda-item">
          <span class="leyenda-circulo" style="background: #e9ecef; border: 2px solid #ced4da;"></span>
          <span>Sin asignar</span>
        </div>
      </div>

      <!-- TOOLBAR -->
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">

        <!-- Grupo izquierdo: Filtros -->
        <div class="d-flex align-items-center gap-1">
          <input type="text" id="txtBusqueda" class="form-control" 
                 placeholder="üîç Buscar trabajador..." 
                 onkeyup="filtrarTablaHorizontal()"
                 style="max-width: 250px; height:30px; border: 1px solid black;">
          
          <select id="filtroCategoriaEPP" class="form-select" 
                  onchange="filtrarTablaHorizontal()"
                  style="max-width: 180px; height:30px; border: 1px solid black;">
            <option value="">üì¶ Todas</option>
            <option value="epp">üõ°Ô∏è Solo EPP</option>
            <option value="uniforme">üëï Solo Uniformes</option>
          </select>
          
          <button class="btn btn-secondary btn-sm" onclick="cargarDatosMaestro()">
            <i class="fas fa-sync-alt"></i> Actualizar
          </button>

          <button class="btn btn-warning btn-sm" onclick="window.print()">
            <i class="fa-solid fa-print"></i>
          </button>
        </div>

        <!-- Grupo centro: KPIs -->
        <div class="d-flex align-items-center gap-2" id="kpisContainer">
          <div style="color: #6c757d; font-size: 12px;">Cargando...</div>
        </div>

        <!-- Grupo derecho: Acciones -->
        <div class="d-flex align-items-center gap-1">
          <button class="btn btn-warning btn-sm" onclick="generarListaCompra()">
            <i class="fas fa-shopping-cart"></i> Lista de Compra
          </button>
          <button class="btn btn-danger btn-sm" onclick="exportarPendientesPDF()">
            <i class="fas fa-file-pdf"></i> Exportar PDF
          </button>
        </div>

      </div>

      <!-- LOADING -->
      <div id="loadingMaestroEPP" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Preparando informaci√≥n...</p>
      </div>

      <!-- TABLA HORIZONTAL -->
      <div class="scroll-horizontal print-container">
        <div class="tabla-horizontal" id="tablaHorizontal">
          <div style="padding: 40px; text-align: center;">
            <div class="spinner-border spinner-border-sm text-primary"></div>
            <br>Cargando datos...
          </div>
        </div>
      </div>

    </div>
    
    <!-- TAB: ALERTAS Y PENDIENTES -->
    <div id="vistaAlertas" class="tab-pane fade">
      <div id="alertasContainer">
        <div style="padding: 40px; text-align: center; color: #6c757d;">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <br>Cargando alertas...
        </div>
      </div>
    </div>
    
  </div>
</div>

<!-- TOOLTIP -->
<div class="tooltip-epp" id="tooltipEPP"></div>

<!-- MODAL IMAGEN -->
<div class="modal-imagen" id="modalImagen">
  <div class="modal-imagen-content">
    <span class="modal-close" onclick="cerrarModalImagen()">&times;</span>
    <img class="modal-imagen-img" id="modalImg" src="" alt="EPP">
    <div class="modal-imagen-title" id="modalTitle"></div>
    <div class="modal-imagen-desc" id="modalDesc"></div>
  </div>
</div>

<script>
  var cargarDatosMaestro;
  var filtrarTablaHorizontal;
  var mostrarTooltip;
  var ocultarTooltip;
  var abrirModalImagen;
  var cerrarModalImagen;
  var exportarPendientesPDF;
  var generarListaCompra;
  var mostrarVista;

  (function() {
    'use strict';

    let datosCompletos = [];
    let trabajadoresUnicos = [];
    let eppsUnicos = [];
    let productMeta = new Map();
    let categoriasEPP = {};

    const PLACEHOLDER_IMG = 'https://lh5.googleusercontent.com/d/1n38-t1dDdj56TqOjv8c4SAAcUQcA0U72';

    // ========== OBTENER METADATA ==========
    async function getProductMeta(pb) {
      if (productMeta.has(pb)) return productMeta.get(pb);
      
      try {
        const res = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .searchStockPaged({ term: pb, limit: 0 });
        });
        
        const rows = res?.rows || [];
        const samePB = rows.filter(r => (r.PRODUCTO || '') === pb);
        const pick = (arr, key) => (arr.find(r => r[key]) || rows.find(r => r[key]) || {})[key] || '';
        const img = pick(samePB, 'IMG');
        const categoria = pick(samePB, 'CATEGORIA');
        
        if (categoria) {
          categoriasEPP[pb] = categoria.toLowerCase();
        }
        
        const meta = { img: img || PLACEHOLDER_IMG };
        productMeta.set(pb, meta);
        return meta;
      } catch(e) {
        const meta = { img: PLACEHOLDER_IMG };
        productMeta.set(pb, meta);
        return meta;
      }
    }

    // ========== CARGAR DATOS ==========
    function _cargarDatosMaestro() {
      console.log('üîÑ Cargando datos del maestro...');
      const contenedor = document.getElementById('tablaHorizontal');
      const loading = document.getElementById('loadingMaestroEPP');
      
      if(!contenedor) return;

      loading.style.display = 'block';
      contenedor.innerHTML = '<div style="padding: 40px; text-align: center;"><div class="spinner-border spinner-border-sm text-primary"></div><br>Cargando datos...</div>';

      google.script.run
        .withSuccessHandler(function(data) {
          console.log('‚úÖ Datos recibidos:', data);
          datosCompletos = data || [];
          
          if (!datosCompletos.length) {
            contenedor.innerHTML = '<div style="padding: 40px; text-align: center; color: #6c757d;">No hay datos disponibles</div>';
            loading.style.display = 'none';
            return;
          }
          
          procesarDatos();
        })
        .withFailureHandler(function(err) {
          console.error('‚ùå Error:', err);
          contenedor.innerHTML = '<div style="padding: 40px; color: #dc3545; text-align: center;"><strong>Error:</strong> ' + (err.message || err) + '</div>';
          loading.style.display = 'none';
        })
        .obtenerMaestroCompleto();
    }

    // ========== PROCESAR DATOS (VERSI√ìN OPTIMIZADA) ==========
async function procesarDatos() {
  console.log('üìä Procesando datos...');
  const contenedor = document.getElementById('tablaHorizontal');
  const loading = document.getElementById('loadingMaestroEPP');

  // Extraer trabajadores √∫nicos
  const mapaTrabajadores = new Map();
  datosCompletos.forEach(reg => {
    if (reg.trabajador && !mapaTrabajadores.has(reg.trabajador)) {
      mapaTrabajadores.set(reg.trabajador, {
        nombre: reg.trabajador,
        cargo: reg.cargo || 'Sin cargo'
      });
    }
  });
  trabajadoresUnicos = Array.from(mapaTrabajadores.values());

  // Extraer EPPs √∫nicos
  const setEPPs = new Set();
  datosCompletos.forEach(reg => {
    if (reg.producto) setEPPs.add(reg.producto);
  });
  eppsUnicos = Array.from(setEPPs).sort();

  console.log('‚úÖ Datos procesados - Trabajadores:', trabajadoresUnicos.length, 'EPPs:', eppsUnicos.length);
  
  // üöÄ RENDERIZAR INMEDIATAMENTE (sin esperar im√°genes)
  renderizarKPIs();
  renderizarTabla(); // ‚Üê Tabla aparece AL INSTANTE con placeholders
  renderizarAlertas();
  
  loading.style.display = 'none';
  
  // üîÑ Cargar im√°genes EN SEGUNDO PLANO
  console.log('üñºÔ∏è Cargando im√°genes en segundo plano...');
  
  let cargadas = 0;
  const total = eppsUnicos.length;
  
  // Cargar todas las im√°genes en paralelo
  await Promise.all(eppsUnicos.map(async (epp) => {
    await getProductMeta(epp);
    cargadas++;
    
    // Actualizar SOLO el header de este EPP (sin re-renderizar toda la tabla)
    actualizarHeaderEPP(epp);
    
    // Log de progreso cada 5 im√°genes
    if (cargadas % 5 === 0 || cargadas === total) {
      console.log(`üì∏ Im√°genes cargadas: ${cargadas}/${total}`);
    }
  }));
  
  console.log('‚úÖ Todas las im√°genes cargadas');
}

// üÜï FUNCI√ìN PARA ACTUALIZAR SOLO UN HEADER DE EPP
function actualizarHeaderEPP(epp) {
  const meta = productMeta.get(epp) || { img: PLACEHOLDER_IMG };
  const header = document.querySelector(`.columna-epp[data-producto="${epp.toLowerCase()}"] .header-epp-img`);
  
  if (header && header.src !== meta.img) {
    header.src = meta.img;
    
    // Animaci√≥n suave al cargar
    header.style.opacity = '0';
    setTimeout(() => {
      header.style.transition = 'opacity 0.3s ease';
      header.style.opacity = '1';
    }, 10);
  }
}


    // ========== RENDERIZAR KPIs ==========
    function renderizarKPIs() {
      const vigentes = datosCompletos.filter(r => r.estado === 'VIGENTE').length;
      const porVencer = datosCompletos.filter(r => r.estado === 'POR VENCER').length;
      const vencidos = datosCompletos.filter(r => r.estado === 'VENCIDO').length;
      
      const html = `
        <div class="kpi-card verde">
          <div>
            <div class="kpi-value">${vigentes}</div>
            <div class="kpi-label">Vigentes</div>
          </div>
        </div>
        <div class="kpi-card naranja">
          <div>
            <div class="kpi-value">${porVencer}</div>
            <div class="kpi-label">Por vencer</div>
          </div>
        </div>
        <div class="kpi-card rojo">
          <div>
            <div class="kpi-value">${vencidos}</div>
            <div class="kpi-label">Vencidos</div>
          </div>
        </div>
      `;
      
      document.getElementById('kpisContainer').innerHTML = html;
    }

    // ========== RENDERIZAR ALERTAS ==========
    function renderizarAlertas() {
      const pendientes = datosCompletos.filter(r => r.estado === 'VENCIDO' || r.estado === 'POR VENCER');
      const badge = document.getElementById('badgeAlertas');
      if (badge) badge.textContent = pendientes.length;
      
      const container = document.getElementById('alertasContainer');
      if (!container) return;
      
      if (pendientes.length === 0) {
        container.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #198754;">
            <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
            <h5>¬°Todo en orden!</h5>
            <p>No hay alertas pendientes</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      pendientes.forEach(reg => {
        const esVencido = reg.estado === 'VENCIDO';
        const diasTexto = esVencido 
          ? `${Math.abs(reg.diasRestantes || 0)} d√≠as de retraso` 
          : `Vence en ${reg.diasRestantes || 0} d√≠as`;
        
        html += `
          <div class="alert-card" style="border-left-color: ${esVencido ? '#dc3545' : '#ffc107'}">
            <div class="alert-header">
              <div class="alert-title">${escapeHtml(reg.trabajador || 'Sin nombre')}</div>
              <div class="alert-badge" style="background: ${esVencido ? '#dc3545' : '#ffc107'}">
                ${esVencido ? 'VENCIDO' : 'POR VENCER'}
              </div>
            </div>
            <div class="alert-body">
              ${escapeHtml(reg.producto || 'Sin producto')} ${reg.variante ? '- ' + escapeHtml(reg.variante) : ''}
            </div>
            <div class="alert-meta">
              <div class="alert-meta-item">
                <i class="fas fa-calendar"></i>
                ${diasTexto}
              </div>
              <div class="alert-meta-item">
                <i class="fas fa-clock"></i>
                Vence: ${reg.vencimiento || 'N/A'}
              </div>
              <div class="alert-meta-item">
                <i class="fas fa-user"></i>
                ${escapeHtml(reg.cargo || 'Sin cargo')}
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      console.log('‚úÖ Alertas renderizadas:', pendientes.length);
    }

    // ========== RENDERIZAR TABLA ==========
    function renderizarTabla() {
      console.log('üìã Renderizando tabla...');
      const contenedor = document.getElementById('tablaHorizontal');
      let html = '';

      // COLUMNA DE TRABAJADORES
      html += '<div class="columna-trabajador">';
      html += '<div class="header-trabajador">üë∑ PERSONAL</div>';
      
      trabajadoresUnicos.forEach(trabajador => {
        html += `
          <div class="celda-trabajador" data-trabajador="${(trabajador.nombre || '').toLowerCase()}">
            <div class="nombre-trabajador">${escapeHtml(trabajador.nombre || 'Sin nombre')}</div>
            <div class="cargo-trabajador">${escapeHtml(trabajador.cargo || 'Sin cargo')}</div>
          </div>
        `;
      });
      html += '</div>';

      // COLUMNAS DE EPPs
      eppsUnicos.forEach(epp => {
        const meta = productMeta.get(epp) || { img: PLACEHOLDER_IMG };
        const categoria = categoriasEPP[epp] || '';
        
        html += `<div class="columna-epp" data-producto="${epp.toLowerCase()}" data-categoria="${categoria}">`;
        html += `
          <div class="header-epp" onclick="abrirModalImagen('${escapeHtml(epp).replace(/'/g, "\\'")}', '${meta.img}')">
            <img src="${meta.img}" 
                 class="header-epp-img" 
                 alt="${escapeHtml(epp)}"
                 onerror="this.src='${PLACEHOLDER_IMG}'">
          </div>
        `;
        
        trabajadoresUnicos.forEach(trabajador => {
          const registro = datosCompletos.find(r => 
            r.trabajador === trabajador.nombre && r.producto === epp
          );
          
          if (registro) {
            const tooltipData = {
              epp: epp,
              trabajador: trabajador.nombre,
              fecha: registro.fecha || 'N/A',
              variante: registro.variante || 'N/A',
              vencimiento: registro.vencimiento || 'N/A',
              estado: registro.estado || 'N/A',
              dias: registro.diasRestantes || 0
            };
            
            html += `
              <div class="celda-epp">
                <span class="semaforo ${registro.clase || 'sin-asignar'}" 
                      data-tooltip='${JSON.stringify(tooltipData).replace(/'/g, "&#39;")}'
                      onmouseover="mostrarTooltip(event, this)"
                      onmouseout="ocultarTooltip()">
                </span>
              </div>
            `;
          } else {
            html += '<div class="celda-epp"><span class="semaforo sin-asignar"></span></div>';
          }
        });
        
        html += '</div>';
      });

      contenedor.innerHTML = html;
      console.log('‚úÖ Tabla renderizada');
    }

    // ========== MODAL IMAGEN ==========
    function _abrirModalImagen(nombre, img) {
      document.getElementById('modalImg').src = img;
      document.getElementById('modalTitle').textContent = nombre;
      document.getElementById('modalDesc').textContent = 'Equipo de Protecci√≥n Personal';
      document.getElementById('modalImagen').style.display = 'block';
    }

    function _cerrarModalImagen() {
      document.getElementById('modalImagen').style.display = 'none';
    }

    // ========== TOOLTIP ==========
    function _mostrarTooltip(event, elemento) {
      const tooltip = document.getElementById('tooltipEPP');
      const dataStr = elemento.getAttribute('data-tooltip');
      
      if (!dataStr) return;
      
      try {
        const data = JSON.parse(dataStr.replace(/&#39;/g, "'"));
        
        const diasTexto = (data.dias || 0) > 0 
          ? `<span class="badge-dias">${data.dias} d√≠as restantes</span>` 
          : `<span class="badge-retraso">${Math.abs(data.dias || 0)} d√≠as de retraso</span>`;
        
        tooltip.innerHTML = `
          <div class="tooltip-header">${escapeHtml(data.epp || 'N/A')}</div>
          <div class="tooltip-row">
            <span class="tooltip-label">Trabajador:</span> 
            <span class="tooltip-value">${escapeHtml(data.trabajador || 'N/A')}</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Fecha Entrega:</span> 
            <span class="tooltip-value">${data.fecha || 'N/A'}</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Variante:</span> 
            <span class="tooltip-value">${escapeHtml(data.variante || 'N/A')}</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Vencimiento:</span> 
            <span class="tooltip-value">${data.vencimiento || 'N/A'}</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Estado:</span> 
            <span class="tooltip-value">${data.estado || 'N/A'}</span>
          </div>
          <div style="text-align: center; margin-top: 8px;">
            ${diasTexto}
          </div>
        `;
        
        tooltip.style.left = event.pageX + 10 + 'px';
        tooltip.style.top = event.pageY - 10 + 'px';
        tooltip.classList.add('show');
      } catch(e) {
        console.error('Error al mostrar tooltip:', e);
      }
    }

    function _ocultarTooltip() {
      const tooltip = document.getElementById('tooltipEPP');
      if (tooltip) tooltip.classList.remove('show');
    }

    // ========== FILTRO ==========
    function _filtrarTablaHorizontal() {
      const busqueda = (document.getElementById('txtBusqueda').value || '').toLowerCase().trim();
      const categoriaFiltro = document.getElementById('filtroCategoriaEPP').value.toLowerCase();
      
      // Filtrar trabajadores
      const trabajadoresVisibles = new Set();
      document.querySelectorAll('.celda-trabajador').forEach((celda, index) => {
        const texto = celda.getAttribute('data-trabajador') || '';
        const esVisible = !busqueda || texto.includes(busqueda);
        
        if (esVisible) {
          celda.classList.remove('fila-oculta');
          trabajadoresVisibles.add(index);
        } else {
          celda.classList.add('fila-oculta');
        }
      });
      
      // Filtrar columnas de EPP por categor√≠a
      document.querySelectorAll('.columna-epp').forEach(colEpp => {
        const categoria = colEpp.getAttribute('data-categoria') || '';
        let mostrarColumna = true;
        
        if (categoriaFiltro === 'epp') {
          mostrarColumna = categoria.includes('epp') || categoria.includes('protecci√≥n') || categoria.includes('proteccion');
        } else if (categoriaFiltro === 'uniforme') {
          mostrarColumna = categoria.includes('uniforme') || categoria.includes('vestimenta') || categoria.includes('ropa');
        }
        
        colEpp.style.display = mostrarColumna ? 'flex' : 'none';
        
        if (mostrarColumna) {
          const celdas = colEpp.querySelectorAll('.celda-epp');
          celdas.forEach((celda, index) => {
            if (trabajadoresVisibles.has(index)) {
              celda.classList.remove('fila-oculta');
            } else {
              celda.classList.add('fila-oculta');
            }
          });
        }
      });
    }

    // ========== CAMBIAR VISTA ==========
    function _mostrarVista(vista) {
      if (vista === 'alertas') {
        setTimeout(() => {
          renderizarAlertas();
        }, 100);
      }
    }

    // ========== EXPORTAR PDF ==========
    function _exportarPendientesPDF() {
      const pendientes = datosCompletos.filter(r => r.estado === 'VENCIDO' || r.estado === 'POR VENCER');
      
      if (pendientes.length === 0) {
        Swal.fire('Sin pendientes', 'No hay EPPs pendientes para exportar', 'info');
        return;
      }

      Swal.fire({
        title: 'Generando PDF...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      google.script.run
        .withSuccessHandler(function(url) {
          Swal.close();
          if (url) {
            window.open(url, '_blank');
            Swal.fire('¬°Listo!', 'PDF generado exitosamente', 'success');
          } else {
            Swal.fire('Advertencia', 'Se gener√≥ el PDF pero no se obtuvo URL', 'warning');
          }
        })
        .withFailureHandler(function(err) {
          Swal.fire('Error', 'Error al exportar: ' + (err.message || err), 'error');
        })
        .generarPDFPendientes(pendientes);
    }

    // ========== LISTA DE COMPRA ==========
    function _generarListaCompra() {
      const vencidos = datosCompletos.filter(r => r.estado === 'VENCIDO');
      
      if (vencidos.length === 0) {
        Swal.fire('Sin vencidos', 'No hay EPPs vencidos que requieran compra', 'info');
        return;
      }

      Swal.fire({
        title: 'Generando lista...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      const agrupado = {};
      vencidos.forEach(r => {
        const key = r.producto;
        if (!agrupado[key]) {
          agrupado[key] = {
            producto: r.producto,
            cantidad: 0,
            trabajadores: []
          };
        }
        agrupado[key].cantidad++;
        agrupado[key].trabajadores.push({
          nombre: r.trabajador,
          variante: r.variante || 'N/A',
          vencimiento: r.vencimiento || 'N/A'
        });
      });
      
      google.script.run
        .withSuccessHandler(function(url) {
          Swal.close();
          if (url) {
            window.open(url, '_blank');
            Swal.fire('¬°Listo!', 'Lista de compra generada exitosamente', 'success');
          } else {
            Swal.fire('Advertencia', 'Se gener√≥ la lista pero no se obtuvo URL', 'warning');
          }
        })
        .withFailureHandler(function(err) {
          Swal.fire('Error', 'Error al generar lista: ' + (err.message || err), 'error');
        })
        .generarListaCompra(agrupado);
    }

    // ========== UTILIDADES ==========
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text || '').replace(/[&<>"']/g, m => map[m]);
    }

    // ========== ASIGNAR GLOBALES ==========
    cargarDatosMaestro = _cargarDatosMaestro;
    filtrarTablaHorizontal = _filtrarTablaHorizontal;
    mostrarTooltip = _mostrarTooltip;
    ocultarTooltip = _ocultarTooltip;
    abrirModalImagen = _abrirModalImagen;
    cerrarModalImagen = _cerrarModalImagen;
    exportarPendientesPDF = _exportarPendientesPDF;
    generarListaCompra = _generarListaCompra;
    mostrarVista = _mostrarVista;

    window.cargarDatosMaestro = _cargarDatosMaestro;
    window.filtrarTablaHorizontal = _filtrarTablaHorizontal;
    window.mostrarTooltip = _mostrarTooltip;
    window.ocultarTooltip = _ocultarTooltip;
    window.abrirModalImagen = _abrirModalImagen;
    window.cerrarModalImagen = _cerrarModalImagen;
    window.exportarPendientesPDF = _exportarPendientesPDF;
    window.generarListaCompra = _generarListaCompra;
    window.mostrarVista = _mostrarVista;

    // ========== INICIALIZACI√ìN AUTOM√ÅTICA ==========
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Iniciando carga autom√°tica...');
      _cargarDatosMaestro();
    });

    // Click fuera del modal
    window.onclick = function(event) {
      const modal = document.getElementById('modalImagen');
      if (event.target === modal) {
        _cerrarModalImagen();
      }
    }

    console.log('‚úÖ Sistema EPP Maestro inicializado');

  })();
</script>

  </body>
</html>
