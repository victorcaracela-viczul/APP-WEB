<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <div class="d-flex align-items-center mt-3">
      <div class="bg-purple rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; background-color: #6f42c1;">
        <i class="fas fa-pen-alt text-white"></i>
      </div>
      <div>
        <h5 class="mb-0" style="color: #6f42c1;">Ex√°menes</h5>
        <small class="text-muted">Preguntas y respuestas</small>
      </div>
    </div>

    <div class="container-fluid my-1 px-0">
      <!-- ‚úÖ Botones y buscador -->
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <div class="d-flex align-items-center gap-1">
          <button onclick="abrirFormulario2()" class="btn btn-secondary btn-sm">Nuevo examen</button>
          <button class="btn btn-warning btn-sm" id="btn2" onclick="window.print()" style="font-size:15px;">
            <i class="fa-solid fa-print"></i>
          </button>
          <button class="btn btn-warning btn-sm rounded-pill" onclick="abrirPanelNotifCap()" title="Enviar alerta a trabajadores">
            <i class="fas fa-bell me-1"></i> Notificar
          </button>
        </div>
        <div class="d-flex align-items-center gap-1">
          <input type="text" id="buscador2" class="form-control" placeholder="Buscar..." style="max-width: 250px; height:30px;">
          <button id="btnBuscarExamen" class="btn btn-info btn-sm">Buscar</button>
        </div>
      </div>

      <!-- Modal Notificaciones Capacitaciones -->
      <dialog id="dialogNotifCap" class="border-0 rounded-3 shadow p-0" style="width:90%;max-width:500px;">
        <div style="background:linear-gradient(135deg,#ffc107,#ff9800);padding:12px 20px;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center">
          <h6 style="margin:0;font-weight:700;color:#1a1a2e"><i class="fas fa-bell me-2"></i>Enviar Alerta de Capacitaci√≥n</h6>
          <button type="button" class="btn-close" onclick="document.getElementById('dialogNotifCap').close()"></button>
        </div>
        <div style="padding:20px">
          <p class="text-muted" style="font-size:12px">
            Env√≠a una alerta con vibraci√≥n y sonido al celular de los trabajadores.
          </p>
          <div class="mb-3">
            <label class="form-label fw-bold" style="font-size:13px">Destinatario</label>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-dark notifCap-modo-btn" data-modo="individual" onclick="setModoNotifCap('individual')">
                <i class="fas fa-user me-1"></i> Individual
              </button>
              <button class="btn btn-sm btn-outline-dark notifCap-modo-btn" data-modo="todos" onclick="setModoNotifCap('todos')">
                <i class="fas fa-users me-1"></i> Todos
              </button>
            </div>
          </div>
          <div class="mb-3" id="notifCap_selectBox">
            <label class="form-label fw-bold" style="font-size:13px">Trabajador</label>
            <select id="notifCap_trabajador" class="form-select form-select-sm">
              <option value="">Cargando...</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold" style="font-size:13px">T√≠tulo</label>
            <input type="text" id="notifCap_titulo" class="form-control form-control-sm" value="Alerta Capacitaci√≥n" maxlength="60">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold" style="font-size:13px">Mensaje</label>
            <textarea id="notifCap_mensaje" class="form-control form-control-sm" rows="3" maxlength="200">Tienes una capacitaci√≥n pendiente. Revisa tu app.</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold" style="font-size:13px">Mensajes r√°pidos</label>
            <div class="d-flex flex-wrap gap-1">
              <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('notifCap_mensaje').value='Tienes una capacitaci√≥n pendiente. Revisa tu app.'">Cap. Pendiente</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('notifCap_mensaje').value='Capacitaci√≥n programada para hoy. Pres√©ntate a tiempo.'">Cap. Hoy</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('notifCap_mensaje').value='Firma tu registro de capacitaci√≥n en la app.'">Firmar Registro</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('notifCap_mensaje').value='Evaluaci√≥n disponible. Ingresa a la app para completarla.'">Evaluaci√≥n</button>
            </div>
          </div>
          <div id="notifCap_resultado" class="mb-2" style="display:none"></div>
          <button id="btnEnviarNotifCap" class="btn btn-warning w-100 fw-bold" onclick="enviarNotifCap()">
            <i class="fas fa-paper-plane me-2"></i>Enviar Alerta
          </button>
        </div>
      </dialog>

      <div id="loadingTablaExamen" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando ex√°menes...</p>
      </div>

      <div class="table-responsive">
        <table class="table print-container">
          <thead><tr id="encabezados2"></tr></thead>
          <tbody id="cuerpo2"></tbody>
        </table>
      </div>

      <div class="text-start my-3">
        <button id="btnVerMasExamen" class="btn btn-outline-secondary shadow-sm" style="display:none;" onclick="verMasExamen()">
          <i class="fa-solid fa-arrow-down"></i> Ver m√°s
        </button>
      </div>
    </div>

    <!-- üß© MODAL -->
    <dialog id="modal2" class="border-0 rounded-3 shadow p-2" style="width: 90%; max-width: 600px;">
      <div class="modal-content border-0">
        <div class="modal-header py-2">
          <h5 class="modal-title w-100 text-center" id="modal-titulo2">Editar examen</h5>
          <button type="button" class="btn-close" aria-label="Cerrar" onclick="cerrarModal2()"></button>
        </div>
        <div class="modal-body">
          <form id="formulario2" method="dialog"></form>
          <div id="mensaje-error2" class="text-danger mt-2" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button id="btn-guardar2" type="button" onclick="guardarCambios2()" class="btn btn-primary">Guardar</button>
          <button type="button" onclick="cerrarModal2()" class="btn btn-secondary">Cancelar</button>
        </div>
      </div>
    </dialog>

    <script>
      let datosGlobales2 = [];
      let headers2 = [];
      let datosExamen = [];
      let totalExamen = 0;
      let offsetExamen = 0;
      const limitExamen = 30;
      let filtroExamen = "";
      let opcionesSelect1 = [];
      let opcionesSelect2 = [];
      let datosMatrizSheet = [];
      let datosTemasSheet = []; 

      document.getElementById("btnBuscarExamen").addEventListener("click", () => {
        offsetExamen = 0;
        filtroExamen = document.getElementById("buscador2").value.toLowerCase();
        datosExamen = [];
        cargarDatos2();
      });

      function verMasExamen() {
        offsetExamen += limitExamen;
        cargarDatos2();
      }

     google.script.run.withSuccessHandler(function (res) {
        opcionesSelect1 = res.opciones1;
        datosMatrizSheet = res.datosMatrizSheet; // Relaci√≥n de la Matriz
        datosTemasSheet = res.datosTemasSheet;   // Relaci√≥n de hoja TEMAS
      }).obtenerOpcionesFormulario();

      function cargarDatos2() {
        document.getElementById("loadingTablaExamen").style.display = "block";
        const btnVerMasExamen = document.getElementById("btnVerMasExamen");
        btnVerMasExamen.disabled = true;
        google.script.run.withSuccessHandler(function (res) {
          if (!res?.headers2 || !res?.filas) return console.error("Datos incompletos:", res);
          if (offsetExamen === 0) {
            headers2 = res.headers2;
            datosExamen = res.filas;
            datosGlobales2 = datosExamen.slice();
            document.getElementById("encabezados2").innerHTML = headers2.map(h => `<th>${h}</th>`).join("") + "<th>Acci√≥n</th>";
          } else {
            datosExamen = datosExamen.concat(res.filas);
            datosGlobales2 = datosExamen.slice();
          }
          totalExamen = res.total;
          mostrarFilas2(datosExamen);
          const btnVerMas = document.getElementById("btnVerMasExamen");
          btnVerMas.style.display = (datosExamen.length < totalExamen) ? "inline-block" : "none";
          document.getElementById("loadingTablaExamen").style.display = "none";
          btnVerMasExamen.disabled = false;
        }).obtenerMatrizExamenPaginado(offsetExamen, limitExamen, filtroExamen);
      }

      function mostrarFilas2(data) {
        const tbody = document.getElementById("cuerpo2");
        tbody.innerHTML = "";
        const fragment = document.createDocumentFragment();
        data.forEach((fila) => {
          const tr = document.createElement("tr");
          fila.forEach((celda, colIndex) => {
            const td = document.createElement("td");
            if (colIndex === 4 && typeof celda === 'string' && celda.startsWith('http')) {
              const img = document.createElement("img");
              img.src = celda;
              img.alt = "Imagen";
              img.style.maxWidth = "100px";
              img.style.maxHeight = "60px";
              td.appendChild(img);
            } else {
              td.textContent = celda;
            }
            tr.appendChild(td);
          });
          const btnTd = document.createElement("td");
          const btnEditar = document.createElement("button");
          btnEditar.innerHTML = '<i class="fa-solid fa-pen"></i>';
          btnEditar.className = "btn btn-sm btn-info me-1";
          btnEditar.onclick = () => abrirFormulario2(fila[0]);
          const btnEliminar = document.createElement("button");
          btnEliminar.innerHTML = '<i class="fa-solid fa-trash"></i>';
          btnEliminar.className = "btn btn-sm btn-danger";
          btnEliminar.onclick = () => eliminarRegistro2(fila[0]);
          btnTd.appendChild(btnEditar);
          btnTd.appendChild(btnEliminar);
          tr.appendChild(btnTd);
          fragment.appendChild(tr);
        });
        tbody.appendChild(fragment);
      }

      // ==================== MULTIPREGUNTA ====================
      let preguntasActuales = [];
      let indiceActual = 0;
      let esEdicion = false;
      let idsOriginales = [];

      function abrirFormulario2(id = null) {
  const modal2 = document.getElementById("modal2");
  const form = document.getElementById("formulario2");
  esEdicion = id !== null;

  // 1. Inyecci√≥n de HTML (Se mantiene tu estructura original)
  form.innerHTML = `
  <div class="form-check form-switch mb-3 border-bottom pb-2">
    <input class="form-check-input" type="checkbox" id="switchOrigen" checked>
    <label class="form-check-label fw-bold" for="switchOrigen" id="labelOrigen">Origen: Matriz de Capacitaci√≥n</label>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="fw-semibold">√Årea</label>
      <select id="areaSelect" class="form-select"></select>
    </div>
    <div class="col-md-6 mb-3">
      <label class="fw-semibold">Tema</label>
      <select id="temaSelect" class="form-select"></select>
    </div>
  </div>

  ${!id ? `
   <div class="mt-3 border rounded p-2 bg-light">
    <div class="row mb-3 align-items-end">
      <div class="col-5">
        <label class="fw-semibold">N√∫mero de preguntas</label>
        <input type="number" id="numPreguntas" class="form-control" placeholder="Ej. 5">
      </div>
      <div class="col-7">
        <label class="fw-semibold">Archivo base (opcional)</label>
        <input type="file" id="archivoBase" class="form-control" accept=".pdf,.doc,.docx,.txt">
      </div>
    </div>
    <div class="mb-3">
      <label class="fw-semibold">Texto base o descripci√≥n del tema</label>
      <textarea id="textoBase" class="form-control" rows="3" placeholder="Escribe aqu√≠ el texto o tema base para generar preguntas..."></textarea>
    </div>
    <div class="text-center mb-3">
      <button type="button" id="btnGenerarIA" class="btn btn-outline-success">
        <i class="fa-solid fa-brain"></i> Generar con IA
      </button>
    </div>
    <div id="mensajeIA" class="text-center text-muted small mb-2"></div>
  </div>` : ""}

  <div id="preguntas-container" class="mt-3 text-center text-muted">
    ${id ? "Estamos obteniendo la informaci√≥n..." : ""}
  </div>

  <div class="d-flex justify-content-between mt-3 flex-wrap gap-2 pt-2 border-top">
    <button type="button" id="btnAnterior" class="btn btn-outline-secondary">Anterior</button>
    <button type="button" id="btnSiguiente" class="btn btn-outline-secondary">Siguiente</button>
    <button type="button" id="btnEliminar" class="btn btn-danger">Eliminar</button>
    <button type="button" id="btnNueva" class="btn btn-success">+ Agregar</button>
  </div>
`;

  // --- Elementos del DOM ---
  const areaSelect = document.getElementById("areaSelect");
  const temaSelect = document.getElementById("temaSelect");
  const switchOrigen = document.getElementById("switchOrigen");
  const labelOrigen = document.getElementById("labelOrigen");

  // --- L√≥gica de Filtrado Unificada ---
  function cargarOpciones() {
    // Determinar qu√© fuente de datos usar
    const fuente = switchOrigen.checked ? datosMatrizSheet : datosTemasSheet;
    
    // Actualizar Label y estilo
    labelOrigen.innerText = switchOrigen.checked ? "Origen: Matriz de Capacitaci√≥n" : "Origen: TEMAS no previstos";
    if (switchOrigen.checked) {
        labelOrigen.classList.add("text-primary");
        labelOrigen.classList.remove("text-secondary");
    } else {
        labelOrigen.classList.add("text-secondary");
        labelOrigen.classList.remove("text-primary");
    }

    // 1. Obtener √Åreas √önicas de la fuente seleccionada
    const areasUnicas = [...new Set(fuente.map(d => d[1]))].sort();
    areaSelect.innerHTML = areasUnicas.map(a => `<option value="${a}">${a}</option>`).join("");

    // 2. Funci√≥n para filtrar temas bas√°ndose en el √°rea seleccionada
    const filtrarTemasPorArea = () => {
      const areaSeleccionada = areaSelect.value;
      const temasFiltrados = fuente
        .filter(d => d[1] === areaSeleccionada)
        .map(d => d[0]);
      temaSelect.innerHTML = temasFiltrados.map(t => `<option value="${t}">${t}</option>`).join("");
    };

    // Asignar el evento y ejecutarlo por primera vez
    areaSelect.onchange = filtrarTemasPorArea;
    filtrarTemasPorArea(); 
  }

  // Evento del Switch
  switchOrigen.onchange = cargarOpciones;
  
  // Inicializaci√≥n de los desplegables
  cargarOpciones();

  // --- L√≥gica de Edici√≥n ---
  if (esEdicion) {
    const fila = datosGlobales2.find(f => f[0] === id);
    const area = fila?.[1] || "";
    const tema = fila?.[2] || "";

    // Auto-detecci√≥n: Si el tema no est√° en la Matriz, cambiamos el switch a modo TEMAS
    const estaEnMatriz = datosMatrizSheet.some(d => d[0] === tema);
    if (!estaEnMatriz) {
      switchOrigen.checked = false;
      cargarOpciones();
    }

    areaSelect.value = area;
    areaSelect.onchange(); // Poblamos el select de temas seg√∫n el √°rea de la edici√≥n
    temaSelect.value = tema;

    google.script.run.withSuccessHandler(res => {
      preguntasActuales = res.map(r => ({ ...r }));
      idsOriginales = res.map(r => r.id);
      indiceActual = 0;
      mostrarPregunta();
    }).obtenerPreguntasPorTema(tema);
  } else {
    // Modo Nuevo Registro
    preguntasActuales = [crearNuevaPregunta()];
    indiceActual = 0;
    mostrarPregunta();
    document.getElementById("btnGenerarIA").addEventListener("click", generarConIA);
  }

  modal2.showModal();

  // --- Asignaci√≥n de Botones de Navegaci√≥n ---
  document.getElementById("btnAnterior").onclick = anteriorPregunta;
  document.getElementById("btnSiguiente").onclick = siguientePregunta;
  document.getElementById("btnEliminar").onclick = eliminarPreguntaActual;
  document.getElementById("btnNueva").onclick = agregarPreguntaNueva;
}

      function generarConIA() {
  const textoBase = document.getElementById("textoBase").value.trim();
  const numPreguntas = parseInt(document.getElementById("numPreguntas").value);
  const archivo = document.getElementById("archivoBase").files[0];
  const msg = document.getElementById("mensajeIA");

  msg.innerHTML = "";

  // ‚ö†Ô∏è Validaciones b√°sicas
  if (!numPreguntas || numPreguntas < 1) {
    msg.innerHTML = `<span class="text-danger">‚ö†Ô∏è Debes indicar cu√°ntas preguntas generar.</span>`;
    return;
  }

  if (!textoBase && !archivo) {
    msg.innerHTML = `<span class="text-danger">‚ö†Ô∏è Escribe un texto o sube un archivo para usar la IA.</span>`;
    return;
  }

  // Mostrar mensaje de carga
  msg.innerHTML = `<div class="text-info"><i class="fa-solid fa-spinner fa-spin"></i> Generando preguntas con IA...</div>`;

  // üîπ Funci√≥n para procesar respuesta y actualizar interfaz
  const procesar = (res) => procesarResultadoIA(res, numPreguntas, msg);

  // üîπ Si el usuario subi√≥ un archivo, lo convertimos a base64
  if (archivo) {
    const reader = new FileReader();
    reader.onload = function (ev) {
      const base64 = ev.target.result;
      google.script.run
        .withSuccessHandler(procesar)
        .withFailureHandler(() => {
          msg.innerHTML = `<span class="text-danger">‚ùå Error al procesar la solicitud con Gemini.</span>`;
        })
        .analizarConGemini(base64, numPreguntas, textoBase || null);
    };
    reader.readAsDataURL(archivo);
  } else {
    // üîπ Solo texto
    google.script.run
      .withSuccessHandler(procesar)
      .withFailureHandler(() => {
        msg.innerHTML = `<span class="text-danger">‚ùå Error al generar preguntas desde el texto.</span>`;
      })
      .analizarConGemini(null, numPreguntas, textoBase);
  }
}


function procesarResultadoIA(res, numPreguntas, msg) {
  try {
    const preguntasGeneradas = JSON.parse(res);
    const puntos = Math.round(20 / numPreguntas);
    preguntasActuales = preguntasGeneradas.map(p => ({
      id: "",
      pregunta: p.pregunta || "",
      url: "",
      opciones: p.respuestas || ["", "", "", ""],
      correcta: p.correcta || 1,
      puntos
    }));
    indiceActual = 0;
    mostrarPregunta();
    msg.innerHTML = `<span class="text-success">‚úÖ Preguntas generadas correctamente (${preguntasActuales.length}).</span>`;
  } catch (e) {
    msg.innerHTML = `<span class="text-danger">‚ö†Ô∏è Error: No se pudo interpretar la respuesta de Gemini.</span>`;
  }
}


      function crearNuevaPregunta() {
        return { id: "", pregunta: "", url: "", opciones: ["","","",""], correcta: "", puntos: "" };
      }

      function mostrarPregunta() {
        const c = preguntasActuales[indiceActual];
        const cont = document.getElementById("preguntas-container");
        cont.innerHTML = `
          <div class="mb-2"><label class="fw-semibold">Pregunta ${indiceActual+1}</label>
            <textarea id="p-pregunta" class="form-control" rows="2">${c.pregunta}</textarea>
          </div>
          <div class="mb-2"><label>URL imagen</label>
            <input type="text" id="p-url" class="form-control" value="${c.url}">
          </div>
          ${[0,1,2,3].map(i=>`
            <div class="mb-2">
              <label>Opci√≥n ${i+1}</label>
              <input type="text" id="p-op${i}" class="form-control" value="${c.opciones[i]}">
            </div>`).join("")}
          <div class="row">
            <div class="col-md-6 mb-2">
              <label>Correcta (1-4)</label>
              <input type="number" id="p-correcta" class="form-control" value="${c.correcta}">
            </div>
            <div class="col-md-6 mb-2">
              <label>Puntos</label>
              <input type="number" id="p-puntos" class="form-control" value="${c.puntos}">
            </div>
          </div>
          <div class="text-end text-muted small">Pregunta ${indiceActual+1} de ${preguntasActuales.length}</div>
        `;
      }

      function guardarPreguntaActual() {
        const c = preguntasActuales[indiceActual];
        c.pregunta = document.getElementById("p-pregunta").value.trim();
        c.url = document.getElementById("p-url").value.trim();
        c.opciones = [0,1,2,3].map(i=>document.getElementById(`p-op${i}`).value.trim());
        c.correcta = document.getElementById("p-correcta").value.trim();
        c.puntos = document.getElementById("p-puntos").value.trim();
      }

      function siguientePregunta() { guardarPreguntaActual(); if (indiceActual < preguntasActuales.length - 1) { indiceActual++; mostrarPregunta(); } }
      function anteriorPregunta() { guardarPreguntaActual(); if (indiceActual > 0) { indiceActual--; mostrarPregunta(); } }
      function agregarPreguntaNueva() { guardarPreguntaActual(); preguntasActuales.push(crearNuevaPregunta()); indiceActual = preguntasActuales.length - 1; mostrarPregunta(); }
      function eliminarPreguntaActual() { if (preguntasActuales.length > 1) { preguntasActuales.splice(indiceActual, 1); indiceActual = Math.max(0, indiceActual - 1); mostrarPregunta(); } else { Swal.fire("No se puede eliminar la √∫nica pregunta."); } }

      function guardarCambios2() {
        guardarPreguntaActual();
        const area = document.getElementById("areaSelect").value;
        const tema = document.getElementById("temaSelect").value;

        const todasVacias = preguntasActuales.every(p => !p.pregunta && p.opciones.every(o => !o));
        if (todasVacias) return Swal.fire("Campos vac√≠os", "Debe ingresar al menos una pregunta o respuesta.", "warning");

        const btnGuardar = document.getElementById("btn-guardar2");
        btnGuardar.disabled = true;
        btnGuardar.textContent = "Guardando‚Ä¶";

        const filas = preguntasActuales.map(p => [p.id, area, tema, p.pregunta, p.url, ...p.opciones, p.correcta, p.puntos]);

        google.script.run.withSuccessHandler(()=>{
          Swal.fire("Guardado", "Preguntas registradas correctamente", "success");
          btnGuardar.disabled = false;
          btnGuardar.textContent = "Guardar";
          cerrarModal2();
          cargarDatos2();
        }).withFailureHandler(err=>{
          Swal.fire("Error", err.message, "error");
          btnGuardar.disabled = false;
          btnGuardar.textContent = "Guardar";
        }).guardarPreguntasMultiples(filas, idsOriginales, esEdicion);
      }

      function cerrarModal2() { document.getElementById("modal2").close(); }

      function eliminarRegistro2(id) {
        if (!id) return alert("Registro inv√°lido.");
        Swal.fire({
          title: '¬øEliminar?',
          text: `¬øDeseas eliminar el ID "${id}"?`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'S√≠, eliminar',
          cancelButtonText: 'Cancelar',
        }).then((result) => {
          if (result.isConfirmed) {
            google.script.run.withSuccessHandler(() => {
              datosExamen = datosExamen.filter(fila => String(fila[0]) !== String(id));
                            datosGlobales2 = datosGlobales2.filter(fila => String(fila[0]) !== String(id));
              mostrarFilas2(datosExamen);
              Swal.fire('Eliminado', 'La pregunta fue eliminada.', 'success');
            }).eliminarPreguntaPorID(id);
          }
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        const buscador2 = document.getElementById("buscador2");
        buscador2.addEventListener("input", function () {
          const texto = this.value.toLowerCase();
          const filtrados = datosGlobales2.filter(fila =>
            fila.some(celda => String(celda).toLowerCase().includes(texto))
          );
          mostrarFilas2(filtrados);
        });
        cargarDatos2();
      });

      // ============================================================
      //  NOTIFICACIONES CAPACITACIONES
      // ============================================================
      var _notifCapTrabCargados = false;
      var _notifCapModo = 'individual';

      function abrirPanelNotifCap(){
        var dlg = document.getElementById('dialogNotifCap');
        if(dlg) dlg.showModal();
        if(!_notifCapTrabCargados) _cargarTrabNotifCap();
      }

      function _cargarTrabNotifCap(){
        var sel = document.getElementById('notifCap_trabajador');
        if(!sel) return;
        sel.innerHTML = '<option value="">Cargando...</option>';
        google.script.run
          .withSuccessHandler(function(lista){
            _notifCapTrabCargados = true;
            sel.innerHTML = '<option value="">-- Selecciona trabajador --</option>';
            (lista || []).forEach(function(t){
              var opt = document.createElement('option');
              opt.value = t.dni;
              opt.textContent = t.nombre + (t.cargo ? ' - ' + t.cargo : '');
              sel.appendChild(opt);
            });
          })
          .withFailureHandler(function(){
            sel.innerHTML = '<option value="">Error al cargar</option>';
          })
          .obtenerTrabajadoresParaNotificar();
      }

      function setModoNotifCap(modo){
        _notifCapModo = modo;
        document.querySelectorAll('.notifCap-modo-btn').forEach(function(b){
          b.classList.toggle('btn-dark', b.dataset.modo === modo);
          b.classList.toggle('btn-outline-dark', b.dataset.modo !== modo);
        });
        var selectBox = document.getElementById('notifCap_selectBox');
        if(selectBox) selectBox.style.display = (modo === 'individual') ? '' : 'none';
      }

      function enviarNotifCap(){
        var titulo = (document.getElementById('notifCap_titulo').value || '').trim();
        var mensaje = (document.getElementById('notifCap_mensaje').value || '').trim();
        var btn = document.getElementById('btnEnviarNotifCap');
        var resDiv = document.getElementById('notifCap_resultado');

        if(!titulo){ Swal.fire('Error','Escribe un t√≠tulo','warning'); return; }
        if(!mensaje){ Swal.fire('Error','Escribe un mensaje','warning'); return; }

        var dniOrDnis = '';
        if(_notifCapModo === 'individual'){
          dniOrDnis = document.getElementById('notifCap_trabajador').value;
          if(!dniOrDnis){ Swal.fire('Error','Selecciona un trabajador','warning'); return; }
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
        if(resDiv) resDiv.style.display = 'none';

        google.script.run
          .withSuccessHandler(function(result){
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar Alerta';
            if(resDiv){
              resDiv.style.display = 'block';
              if(result && result.ok){
                var sent = result.sent || 0;
                resDiv.innerHTML = '<div class="alert alert-success py-2 mb-0"><i class="fas fa-check-circle me-1"></i> Alerta enviada. <b>' + sent + '</b> notificaci√≥n(es).</div>';
              } else {
                var err = (result && result.error) ? result.error : 'Error desconocido';
                resDiv.innerHTML = '<div class="alert alert-warning py-2 mb-0"><i class="fas fa-exclamation-triangle me-1"></i> ' + err + '</div>';
              }
            }
          })
          .withFailureHandler(function(err){
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar Alerta';
            if(resDiv){
              resDiv.style.display = 'block';
              resDiv.innerHTML = '<div class="alert alert-danger py-2 mb-0"><i class="fas fa-times-circle me-1"></i> Error: ' + (err.message||err) + '</div>';
            }
          })
          .enviarAlertaCapacitacion(_notifCapModo, dniOrDnis, titulo, mensaje);
      }
    </script>
  </body>
</html>

