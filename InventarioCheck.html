<body>
  <div class="d-flex align-items-center mt-3">
  <div class="bg-purple rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;background-color: #6f42c1;">
    <i class="fas fa-warehouse text-white"></i>
  </div>
  <div>
    <h5 class="mb-0" style="color: #6610f2;">Inventario</h5>
    <small class="text-muted">Equipos, Maquinarias, Herramientas</small>
  </div>
</div>

<div class="container-fluid px-0 my-4" id="inventarioCheck">
 <!-- ‚úÖ Botones y buscador en una sola fila -->
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">

  <!-- üîπ Grupo izquierdo: Botones -->
  <div class="d-flex align-items-center gap-1">
    <button onclick="abrirFormularioInvet()" class="btn btn-secondary btn-sm">Nuevo inventario</button>
    <button class="btn btn-warning btn-sm" id="btnInvetPrint" onclick="window.print()" style="font-size:15px;">
      <i class="fa-solid fa-print"></i>
    </button>
  </div>

  <!-- üîπ Grupo derecho: Buscador + Bot√≥n -->
  <div class="d-flex align-items-center gap-1">
    <input type="text" id="buscadorInvet" class="form-control" placeholder="Buscar..." style="max-width: 250px; height:30px;">
    <button class="btn btn-info btn-sm" onclick="buscarInventario()">Buscar</button>
  </div>

</div>



  </div>
  <div id="loadingInventarioCheck" class="text-center my-4" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Cargando...</span>
  </div>
  <p class="mt-2">Cargando inventario...</p>
</div>
  <div class="table-responsive" style="max-height: 500px;">
    <table class="table table-bordered table-hover my-1 print-container small-table">
      <thead style="position: sticky; top: 0; background-color: white; z-index: 1;">
        <tr id="encabezadosInvet"></tr>
      </thead>
      <tbody id="cuerpoInvet" style="font-size:0.8em;"></tbody>
    </table>
  </div>
<div class="text-center mt-2">
  <button id="btnCargarMasInvet" class="btn btn-outline-secondary" style="display:none;" onclick="cargarDatosInvet()"><i class="fa-solid fa-arrow-down"></i>Ver m√°s</button>
</div>

<dialog id="modalInvet" class="border-0 rounded-3 shadow p-2" style="width: 90%; max-width: 500px;">
  <div class="modal-content border-0">
    <div class="modal-header py-2">
      <h5 class="modal-title w-100 text-center" id="modal-titulo-Invet">Inventario</h5>
      <button type="button" class="btn-close" aria-label="Cerrar" onclick="cerrarModalInvet()"></button>
    </div>
    <div class="modal-body">
      <form id="formularioInvet" method="dialog">
        <!-- Aqu√≠ se insertan los campos din√°micamente -->
      </form>
      <div id="mensaje-error-Invet" class="text-danger mt-2" style="display:none;"></div>
    </div>
    <div class="modal-footer">
      <button id="btn-guardarInvet" type="button" onclick="guardarCambiosInventario()" class="btn btn-primary">Guardar</button>
      <button type="button" onclick="cerrarModalInvet()" class="btn btn-secondary">Cancelar</button>
    </div>
  </div>
</dialog>

  
  <script>
    let datosGlobalesInvet = [];
    let headersInvet = [];

document.addEventListener("DOMContentLoaded", () => {
  // 1. Cargar listas globales y luego los datos del inventario
  google.script.run.withSuccessHandler(function (listas) {
    listasGlobales = listas;
    cargarDatosInvet(true); // Solo cargar datos cuando las listas est√©n listas
  }).getTodasLasListas();

  // 2. Buscador de inventario
  document.getElementById("buscadorInvet").addEventListener("input", function () {
    const texto = this.value.toLowerCase();
    const filtrados = datosGlobalesInvet.filter(fila =>
      fila.some(celda => String(celda).toLowerCase().includes(texto))
    );
    mostrarFilasInvet(filtrados);
  });
});


let offsetInvet = 0;
const limitInvet = 30;
let terminoBusquedaInvet = "";
let totalFilasInvet = 0;

function cargarDatosInvet(reset = false) {
  if (reset) {
    offsetInvet = 0;
    datosGlobalesInvet = [];
  }

  document.getElementById("loadingInventarioCheck").style.display = "block";

  google.script.run.withSuccessHandler(res => {
    headersInvet = res.headersInvet;
    totalFilasInvet = res.total;

    if (offsetInvet === 0) {
      document.getElementById("encabezadosInvet").innerHTML = headersInvet.map(h => `<th>${h}</th>`).join("") + "<th>Acci√≥n</th>";
    }

    datosGlobalesInvet = datosGlobalesInvet.concat(res.filas);

    mostrarFilasInvet(datosGlobalesInvet);

    document.getElementById("loadingInventarioCheck").style.display = "none";

    offsetInvet += limitInvet;

    document.getElementById("btnCargarMasInvet").style.display = (offsetInvet < totalFilasInvet) ? "block" : "none";

  }).obtenerInventarioServerSide(offsetInvet, limitInvet, terminoBusquedaInvet);
}


function buscarInventario() {
  terminoBusquedaInvet = document.getElementById("buscadorInvet").value.trim().toLowerCase();
  cargarDatosInvet(true);
}

    function mostrarFilasInvet(data) {
      const tbody = document.getElementById("cuerpoInvet");
      tbody.innerHTML = "";
      data.forEach((fila, i) => {
        const tr = document.createElement("tr");
        fila.forEach(celda => {
          const td = document.createElement("td");
          td.textContent = celda;
          tr.appendChild(td);
        });

        const btnTd = document.createElement("td");
        btnTd.innerHTML = `
          <button class="btn btn-sm btn-info me-1" onclick="abrirFormularioInvet(${i})">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-danger" onclick="eliminarRegistroInvet(${i})">üóëÔ∏è</button>
        `;
        tr.appendChild(btnTd);
        tbody.appendChild(tr);
      });
    }

function abrirFormularioInvet(index = null) { 
  const modalInvet = document.getElementById("modalInvet");
  const form = document.getElementById("formularioInvet");
  const isNuevo = index === null;
  const valores = isNuevo ? Array(headersInvet.length).fill("") : datosGlobalesInvet[index];
  let contenidoHTML = "";

  headersInvet.forEach((h, i) => {
    const readonly = (i === 0 && !isNuevo) ? "readonly" : "";
    const tipo = [13, 16, 17].includes(i) ? 'date' : 'text';
    const valor = valores[i] || "";

    const formato = tipo === "date" && valor.includes("/") 
      ? valor.split("/").reverse().join("-")
      : valor;

    const obligatorio = ![5, 6, 8, 9, 10, 11, 13, 14, 17].includes(i); // definir si es obligatorio
    const asterisco = obligatorio ? '<span style="color:red">*</span>' : ''; // asterisco rojo
    const atributoRequired = obligatorio ? 'required' : ''; // atributo HTML

    // Campo oculto para nuevo ID
    if (i === 0 && isNuevo) {
      contenidoHTML += `<input name="${h}" type="hidden" value="">`;

    } else if ([1, 2, 3, 5, 15].includes(i)) {
      // Campos con <select> desde listas
      const opciones = (i === 1 ? listasGlobales.empresas : 
                 i === 2 ? listasGlobales.areas :
                 i === 3 ? listasGlobales.equipos :
                 i === 5 ? listasGlobales.lugares :
                           listasGlobales.estados) || [];


      contenidoHTML += `
        <div class="mb-3">
          <label class="form-label">${h} ${asterisco}</label>
          <select name="${h}" class="form-select" ${atributoRequired}>
            ${opciones.map(op => `<option value="${op}" ${op === formato ? "selected" : ""}>${op}</option>`).join("")}
          </select>
        </div>`;

    } else if (i === 12) {
      // Select especial para frecuencia de inspecci√≥n
      const frecuencias = [
        { valor: "0", texto: "0 - √önica vez" },
        { valor: "0,5", texto: "0,5 - Dos veces d√≠a (entrada/salida)" },
        { valor: "1", texto: "1 - Diario" },
        { valor: "7", texto: "7 - Semanal" },
        { valor: "15", texto: "15 - Quincenal" },
        { valor: "30", texto: "30 - Mensual" },
        { valor: "60", texto: "60 - Bimestral" },
        { valor: "90", texto: "90 - Trimestral" },
        { valor: "180", texto: "180 - Semestral" },
        { valor: "365", texto: "365 - Anual" },
        { valor: "730", texto: "730 - Bianual" },
        { valor: "", texto: "Especifico en la base de datos" }
      ];

      contenidoHTML += `
        <div class="mb-3">
          <label class="form-label">${h} ${asterisco}</label>
          <select name="${h}" class="form-select" ${atributoRequired}>
            ${frecuencias.map(f => `<option value="${f.valor}" ${f.valor == formato ? "selected" : ""}>${f.texto}</option>`).join("")}
          </select>
        </div>`;

    } else {
      // Otros campos normales
      contenidoHTML += `
        <div class="mb-3">
          <label class="form-label">${h} ${asterisco}</label>
          <input name="${h}" type="${tipo}" value="${formato}" ${readonly} class="form-control" ${atributoRequired}>
        </div>`;
    }
  });

  form.innerHTML = contenidoHTML;
  form.dataset.index = index;
  document.getElementById("modal-titulo-Invet").textContent = isNuevo ? "Nuevo inventario" : "Editar inventario";
  modalInvet.showModal();
}



    function cerrarModalInvet() {
      document.getElementById("modalInvet").close();
    }

    function guardarCambiosInventario() {
      const btn = document.getElementById("btn-guardarInvet");
      const form = document.getElementById("formularioInvet");
      const campos = form.querySelectorAll("input, select");
      const mensajeError = document.getElementById("mensaje-error-Invet");
      const isNuevo = form.dataset.index === "null";
      const camposVisibles = Array.from(campos).filter((c, i) => !(isNuevo && i === 0));
      // definir si es obligatorio
      const vacios = camposVisibles.some(c => {
        const indexReal = headersInvet.indexOf(c.name);
        return ![5, 6, 8, 9, 10, 11, 13, 14, 17].includes(indexReal) && c.value.trim() === "";
      });



      btn.textContent = "Guardando...";
      btn.disabled = true;

      if (vacios) {
        mensajeError.textContent = "Los campos con * son obligatorios.";
        mensajeError.style.display = "block";
        btn.textContent = "Guardar";
        btn.disabled = false;
        return;
      }

      const data = Array.from(campos).map((el, i) => {
        if ([13, 16, 17].includes(i) && el.value) {
          const partes = el.value.split("-");
          return `${partes[2]}/${partes[1]}/${partes[0]}`; // dd/mm/yyyy
        }
        return el.value.trim();
      });

      const index = form.dataset.index;

      const callback = () => {
        Swal.fire("Guardado", "", "success");
        cerrarModalInvet();
        cargarDatosInvet(true); 
        btn.textContent = "Guardar";
        btn.disabled = false;
      };

      if (index === "null") {
        google.script.run.withSuccessHandler(callback).agregarInventario(data);
      } else {
        google.script.run.withSuccessHandler(callback).actualizarInventario(data);
      }
    }

    function eliminarRegistroInvet(index) {
      const num = datosGlobalesInvet[index][0];
      Swal.fire({
        title: "¬øEliminar?",
        text: `¬øDeseas eliminar el registro N¬∞ ${num}?`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "S√≠, eliminar"
      }).then(res => {
        if (res.isConfirmed) {
          google.script.run.withSuccessHandler(() => {
            Swal.fire("Eliminado", "", "success");
            cargarDatosInvet(true);
          }).eliminarInventarioPorNum(num);
        }
      });
    }


  </script>
</body>

